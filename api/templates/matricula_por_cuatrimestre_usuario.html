{% extends 'base.html' %}
{% load static %}

{% block title %}ðŸ“˜ MatrÃ­cula por Cuatrimestre{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/matricula_por_cuatrimestre.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />

<div class="admin-panel">
  <h2 class="titulo-vista">ðŸ“˜ MatrÃ­cula por Cuatrimestre</h2>

  <!-- Filtros -->
  <form method="get" class="filtros" id="formFiltros">
    <div class="filtro-item">
      <label for="filtroCiclo">Ciclo:</label>
      <select name="ciclo" id="filtroCiclo">
        <option value="Todos">Todos</option>
        {% for c in ciclos %}
          <option value="{{ c.id }}" {% if filtro_ciclo == c.id|stringformat:"s" %}selected{% endif %}>
            {{ c.ciclo.anio }} - {{ c.periodo.clave }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- NUEVO: Tipo de Programa -->
    <div class="filtro-item">
      <label for="filtroTipoPrograma">Tipo de Programa:</label>
      <select name="tipo_programa" id="filtroTipoPrograma">
        <option value="antiguo" {% if tipo_programa == 'antiguo' %}selected{% endif %}>Antiguo</option>
        <option value="nuevo"   {% if tipo_programa == 'nuevo' %}selected{% endif %}>Nuevo</option>
      </select>
    </div>

    <div class="filtro-item">
      <label for="filtroPrograma">Programa Educativo:</label>
      <select name="programa" id="filtroPrograma">
        <option value="Todos">Todos</option>
        {% for p in programas %}
          <option value="{{ p.id }}" {% if filtro_programa == p.id|stringformat:"s" %}selected{% endif %}>{{ p.nombre }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="filtro-item">
      <button type="submit" class="btn-admin">Aplicar filtros</button>
    </div>
  </form>

  <!-- Tabla -->
  <div class="contenedor-tabla mt-4">
    <table class="crud-table">
      <thead>
        <tr>
          <th>Periodo</th>
          <th>Programa</th>
          <th>Cantidad</th>
        </tr>
      </thead>
      <tbody>
        {% for fila in tabla %}
          <tr>
            <td>{{ fila.periodo }}</td>
            <td>{{ fila.programa }}</td>
            <td>{{ fila.cantidad }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="3">No hay datos disponibles.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- GrÃ¡ficas -->
  <div id="contenedorGraficas" class="graficas mt-5" data-grafica-json='{{ datos_grafica|safe }}'>
    <canvas id="graficaBarras" class="grafica" height="70"></canvas>
    <canvas id="graficaLinea" class="grafica mt-4" height="70"></canvas>
    <canvas id="graficaPastel" class="grafica mt-4" height="70"></canvas>
    <canvas id="graficaGauss" class="grafica mt-4" height="70"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/matricula_por_cuatrimestre.js' %}"></script>

<!-- JS: repoblar â€œProgramaâ€ al cambiar â€œTipo de Programaâ€, sin recargar -->
<script>
  // IMPORTANTÃSIMO:
  // En la view, envÃ­a:
  // 'cat_antiguos': json.dumps(list(ProgramaEducativoAntiguo.objects.values('id','nombre').order_by('nombre')))
  // 'cat_nuevos':   json.dumps(list(ProgramaEducativoNuevo.objects.values('id','nombre').order_by('nombre')))
  // y tambiÃ©n 'tipo_programa' actual.

  // Leemos catÃ¡logos serializados desde contexto
  const CAT_ANT = {{ cat_antiguos|safe|default:"[]" }};
  const CAT_NVO = {{ cat_nuevos|safe|default:"[]" }};

  const selTipo = document.getElementById('filtroTipoPrograma');
  const selProg = document.getElementById('filtroPrograma');

  function repoblarProgramas(tipo, keepValue=false){
    const prev = keepValue ? selProg.value : 'Todos';
    const fuente = (tipo === 'nuevo') ? CAT_NVO : CAT_ANT;

    // Limpiar y agregar "Todos"
    selProg.innerHTML = '';
    const optAll = document.createElement('option');
    optAll.value = 'Todos';
    optAll.textContent = 'Todos';
    selProg.appendChild(optAll);

    // Opciones segÃºn tipo
    (fuente || []).forEach(p => {
      const o = document.createElement('option');
      o.value = String(p.id);
      o.textContent = p.nombre;
      selProg.appendChild(o);
    });

    // Restaurar selecciÃ³n si sigue existiendo; si no, "Todos"
    selProg.value = prev && [...selProg.options].some(o => o.value === prev) ? prev : 'Todos';
  }

  // Al cargar: asegura coherencia del combo con el tipo actual
  repoblarProgramas(selTipo?.value || 'antiguo', true);

  // Cambiar al vuelo sin recargar
  selTipo?.addEventListener('change', function(){
    repoblarProgramas(this.value);
    // Si quieres que se comporte EXACTAMENTE como en admin (recargar al cambiar):
    // document.getElementById('formFiltros').submit();
  });
</script>
{% endblock %}
