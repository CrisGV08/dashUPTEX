{% extends 'base.html' %}
{% load static %}

{% block title %}📘 Matrícula por Cuatrimestre{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/matricula_por_cuatrimestre.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />

<style>
  /* Asegura que lo marcado como no-print no aparezca en PDF/impresión */
  .hidden-print { display: none !important; }
  @media print { .no-print { display: none !important; } }
  /* Botonera */
  .acciones { display:flex; justify-content:flex-end; gap:10px; margin:12px 0; }
  /* Alineación de números */
  .num { text-align: right; }
</style>

<div class="admin-panel">
  <h2 class="titulo-vista">📘 Matrícula por Cuatrimestre</h2>

  <!-- Filtros (no salen en PDF) -->
  <form method="get" class="filtros no-print" id="formFiltros" data-html2canvas-ignore="true">
    <div class="filtro-item">
      <label for="filtroCiclo">Ciclo:</label>
      <select name="ciclo" id="filtroCiclo">
        <option value="Todos">Todos</option>
        {% for c in ciclos %}
          <option value="{{ c.id }}" {% if filtro_ciclo == c.id|stringformat:"s" %}selected{% endif %}>
            {{ c.ciclo.anio }} - {{ c.periodo.clave }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="filtro-item">
      <label for="filtroTipoPrograma">Tipo de Programa:</label>
      <select name="tipo_programa" id="filtroTipoPrograma">
        <option value="antiguo" {% if tipo_programa == 'antiguo' %}selected{% endif %}>Antiguo</option>
        <option value="nuevo"   {% if tipo_programa == 'nuevo' %}selected{% endif %}>Nuevo</option>
      </select>
    </div>

    <div class="filtro-item">
      <label for="filtroPrograma">Programa Educativo:</label>
      <select name="programa" id="filtroPrograma">
        <option value="Todos">Todos</option>
        {% for p in programas %}
          <option value="{{ p.id }}" {% if filtro_programa == p.id|stringformat:"s" %}selected{% endif %}>{{ p.nombre }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="filtro-item">
      <button type="submit" class="btn-admin">Aplicar filtros</button>
    </div>
  </form>

  <!-- Contenido exportable a PDF -->
  <div id="contenidoPDF">
    <!-- Tabla -->
    <div class="contenedor-tabla mt-4">
      <table class="crud-table">
        <thead>
          <tr>
            <th>Periodo</th>
            <th>Programa</th>
            <th class="num">Cantidad</th>
          </tr>
        </thead>
        <tbody>
          {% for fila in tabla %}
            <tr>
              <td>{{ fila.periodo }}</td>
              <td>{{ fila.programa }}</td>
              <td class="num">{{ fila.cantidad }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="3">No hay datos disponibles.</td></tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <td colspan="2" class="num"><strong>Total</strong></td>
            <td class="num"><strong>{{ total_general }}</strong></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- Gráficas -->
    <div id="contenedorGraficas" class="graficas mt-5" data-grafica-json='{{ datos_grafica|escapejs }}'>
      <canvas id="graficaBarras" class="grafica" height="70"></canvas>
      <canvas id="graficaLinea" class="grafica mt-4" height="70"></canvas>
      <canvas id="graficaPastel" class="grafica mt-4" height="70"></canvas>
      <canvas id="graficaGauss" class="grafica mt-4" height="70"></canvas>
    </div>
  </div>
</div>

<!-- Librerías (orden importa) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
  if (typeof Chart !== 'undefined' && typeof ChartDataLabels !== 'undefined') {
    Chart.register(ChartDataLabels);
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

<!-- Datos también por variable global (segunda vía) -->
<script>
  window.MPC_DATOS = {{ datos_grafica|safe }};
</script>

<!-- JS de vista usuario (rompe caché con timestamp) -->
<script src="{% static 'js/matricula_por_cuatrimestre_usuario.js' %}?v={% now 'U' %}"></script>

<!-- JS: repoblar “Programa” al cambiar “Tipo de Programa”, sin recargar -->
<script>
  const CAT_ANT = {{ cat_antiguos|default:"[]"|safe }};
  const CAT_NVO = {{ cat_nuevos|default:"[]"|safe }};

  const selTipo = document.getElementById('filtroTipoPrograma');
  const selProg = document.getElementById('filtroPrograma');

  function repoblarProgramas(tipo, keepValue=false){
    if (!selProg) return;
    const prev = keepValue ? selProg.value : 'Todos';
    const fuente = (tipo === 'nuevo') ? CAT_NVO : CAT_ANT;

    selProg.innerHTML = '';
    const optAll = document.createElement('option');
    optAll.value = 'Todos';
    optAll.textContent = 'Todos';
    selProg.appendChild(optAll);

    (fuente || []).forEach(p => {
      const o = document.createElement('option');
      o.value = String(p.id);
      o.textContent = p.nombre;
      selProg.appendChild(o);
    });

    selProg.value = prev && [...selProg.options].some(o => o.value === prev) ? prev : 'Todos';
  }

  // Al cargar
  repoblarProgramas(selTipo?.value || 'antiguo', true);

  // Cambiar al vuelo (si quieres auto-aplicar, descomenta el submit)
  selTipo?.addEventListener('change', function(){
    repoblarProgramas(this.value);
    // document.getElementById('formFiltros').submit();
  });
</script>
{% endblock %}
