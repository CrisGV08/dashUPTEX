{% extends 'base.html' %}
{% load static %}

{% block title %}Aprovechamiento AcadÃ©mico Â· Usuario{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/aprovechamiento.css' %}">

<h1 class="text-center mt-4 mb-3">ðŸ“˜ Aprovechamiento AcadÃ©mico HistÃ³rico</h1>

<div class="container-fluid">

  <!-- ðŸ”Ž Filtros -->
  <div class="card mb-4">
    <div class="card-body">
      <form id="filter-form" onsubmit="return false;">
        <div class="row g-3 align-items-end">

          <!-- Ciclo -->
          <div class="col-lg-4">
            <label class="form-label fw-semibold d-block mb-1">
              <i class="far fa-calendar me-1"></i> Ciclo
            </label>
            <select id="filtroAnio" class="form-control">
              <option value="Todos">Todos</option>
              {% for c in anios %}
                <option value="{{ c }}">{{ c }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Tipos de grÃ¡ficas -->
          <div class="col-lg-4">
            <label class="form-label fw-semibold d-block mb-1">
              <i class="fas fa-chart-bar me-1"></i> GrÃ¡ficas
            </label>
            <div class="btn-check-group">
              <input class="form-check-input grafica-check" type="checkbox" value="barras" id="checkBarras" checked>
              <label class="btn btn-light btn-sm" for="checkBarras">Barras</label>
              <input class="form-check-input grafica-check" type="checkbox" value="linea" id="checkLinea" checked>
              <label class="btn btn-light btn-sm" for="checkLinea">LÃ­nea</label>
              <input class="form-check-input grafica-check" type="checkbox" value="pastel" id="checkPastel" checked>
              <label class="btn btn-light btn-sm" for="checkPastel">Pastel</label>
              <input class="form-check-input grafica-check" type="checkbox" value="gauss" id="checkGauss" checked>
              <label class="btn btn-light btn-sm" for="checkGauss">Gauss</label>
            </div>

            <div class="mt-2 d-flex gap-2">
              <button id="aplicarFiltros" type="button" class="btn btn-primary btn-sm">
                <i class="fas fa-filter"></i> Aplicar
              </button>
              <button id="resetFiltros" type="button" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-sync-alt"></i> Reset
              </button>
            </div>
          </div>

          <!-- Programas Educativos (desde el dataset real) -->
          <div class="col-lg-4">
            <label class="form-label fw-semibold d-block mb-1">
              <i class="fas fa-layer-group me-1"></i> Programas Educativos
            </label>

            <div class="programas-wrapper">
              <div class="programas-scroll">
                <div class="programas-col">
                  <div class="section-title">Nuevos</div>
                  {% for p in programas_nuevos %}
                    <div class="form-check">
                      <input class="form-check-input programa-checkbox" type="checkbox"
                             id="prog-{{ p.id }}" value="{{ p.id }}" checked>
                      <label class="form-check-label" for="prog-{{ p.id }}">{{ p.nombre }}</label>
                    </div>
                  {% endfor %}
                </div>

                <div class="programas-col">
                  <div class="section-title">Antiguos</div>
                  {% for p in programas_antiguos %}
                    <div class="form-check">
                      <input class="form-check-input programa-checkbox" type="checkbox"
                             id="prog-{{ p.id }}" value="{{ p.id }}" checked>
                      <label class="form-check-label" for="prog-{{ p.id }}">{{ p.nombre }}</label>
                    </div>
                  {% endfor %}
                </div>
              </div>

              <div class="d-flex gap-2 mt-2">
                <button type="button" class="btn btn-outline-secondary btn-sm" id="select-all-prog">
                  <i class="fas fa-check-circle me-1"></i> Seleccionar todos
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="clear-all-prog">
                  <i class="fas fa-times-circle me-1"></i> Limpiar
                </button>
              </div>
            </div>
          </div>

        </div>
      </form>
    </div>
  </div>

  <!-- ðŸ“‹ Tabla (debajo de filtros, arriba de grÃ¡ficas) -->
  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h6 class="m-0">ðŸ“‹ Detalle por Programa y Ciclo</h6>
      <span class="badge bg-primary" id="badgeFiltrados">Filtrados: 0</span>
    </div>
    <div class="card-body">
      <div class="table-responsive table-wrapper">
        <table class="table table-bordered table-hover text-center" id="tablaDetalle">
          <thead class="thead-light">
            <tr>
              <th>Ciclo</th>
              <th>Programa</th>
              <th>Promedio</th>
            </tr>
          </thead>
          <tbody>
            {% for fila in detalle_ciclos %}
            <tr>
              <td>{{ fila.ciclo }}</td>
              <td>{{ fila.programa }}</td>
              <td>{{ fila.promedio }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="3" class="text-muted">Sin registros</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="text-muted small mt-2" id="msgSinDatos" style="display:none">
        No hay datos que coincidan con los filtros.
      </div>
    </div>
  </div>

  <!-- ðŸ“ˆ GrÃ¡ficas -->
  <div class="row g-3">
    <div class="col-lg-6 grafica-box" id="box-barras">
      <div class="card h-100 chart-card">
        <div class="card-header"><h6 class="m-0">ðŸ“Š GrÃ¡fico de Barras</h6></div>
        <div class="card-body"><canvas id="graficaBarras" height="250"></canvas></div>
      </div>
    </div>
    <div class="col-lg-6 grafica-box" id="box-linea">
      <div class="card h-100 chart-card">
        <div class="card-header"><h6 class="m-0">ðŸ“ˆ GrÃ¡fico de LÃ­nea</h6></div>
        <div class="card-body"><canvas id="graficaLinea" height="250"></canvas></div>
      </div>
    </div>
    <div class="col-lg-6 grafica-box" id="box-pastel">
      <div class="card h-100 chart-card">
        <div class="card-header"><h6 class="m-0">ðŸ¥§ GrÃ¡fico de Pastel</h6></div>
        <div class="card-body"><canvas id="graficaPastel" height="250"></canvas></div>
      </div>
    </div>
    <div class="col-lg-6 grafica-box" id="box-gauss">
      <div class="card h-100 chart-card">
        <div class="card-header"><h6 class="m-0">ðŸ“‰ Campana de Gauss</h6></div>
        <div class="card-body"><canvas id="graficaGauss" height="250"></canvas></div>
      </div>
    </div>
  </div>
</div>

<!-- ðŸ”¢ Dataset para JS (SIN json_script) -->
<script id="datosGraficas" type="application/json">
  {{ datos_graficas_json|safe }}
</script>

<!-- LibrerÃ­as -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<!-- JS -->
<script src="{% static 'js/aprovechamiento_usuario.js' %}"></script>
{% endblock %}
