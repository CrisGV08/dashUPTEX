{% extends 'base_admin.html' %}
{% load static %}

{% block title %}Titulados Hist칩rico Actual{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
<link rel="stylesheet" href="{% static 'css/titulados_historico_actual.css' %}">

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<div class="admin-panel" id="contenedorPDF">
  <h2 class="titulo-vista">游꿉 Titulados Hist칩rico Actual</h2>

  {% if messages %}
    <div class="msgs">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- ====== Acciones de archivo ====== -->
  <div class="acciones">
    <a class="btn-admin" href="{% url 'descargar_plantilla_titulados_historico_actual' %}">
      Descargar plantilla
    </a>

    <form method="post" enctype="multipart/form-data" class="form-inline">
      {% csrf_token %}
      <input type="file" name="archivo_excel" accept=".xlsx" required>
      <button type="submit" class="btn-admin">Subir archivo</button>
    </form>
  </div>

  <!-- ====== FILTROS SERVIDOR (recarga) ====== -->
  <div class="form-box">
    <form method="get" class="filtros-grid">
      <!-- A침o en "p칤ldoras" -->
      <div>
        <label class="fw-bold">A침o de ingreso</label>
        <!-- select real (env칤o GET) -->
        <select name="anio" id="anioReal" class="form-select" style="display:none">
          <option value="">Todos</option>
          {% for a in anios %}
            <option value="{{ a }}" {% if anio_seleccionado == a|stringformat:"s" %}selected{% endif %}>{{ a }}</option>
          {% endfor %}
        </select>

        <!-- p칤ldoras -->
        <div id="pillsAnios" class="pills">
          <button type="button" class="pill {% if not anio_seleccionado %}active{% endif %}" data-valor="">Todos</button>
          {% for a in anios %}
            <button type="button" class="pill {% if anio_seleccionado == a|stringformat:'s' %}active{% endif %}" data-valor="{{ a }}">{{ a }}</button>
          {% endfor %}
        </div>
      </div>

      <!-- Carreras (IDs) -->
      <div>
        <label class="fw-bold">Carreras (BD)</label>
        <select name="carrera" id="selectCarrerasServer" multiple>
          {% for pid, pnom in carreras_disponibles %}
            <option value="{{ pid }}" {% if pid in carreras_seleccionadas %}selected{% endif %}>{{ pnom }}</option>
          {% endfor %}
        </select>
        <div class="quick-actions">
          <button type="button" class="btn-mini" id="srvSelTodos">Todos</button>
          <button type="button" class="btn-mini" id="srvSelNinguno">Ninguno</button>
          <button type="button" class="btn-mini" id="srvSelInvertir">Invertir</button>
        </div>
      </div>

      <div class="acciones-form">
        <button class="btn-admin" type="submit">Aplicar filtros</button>
      </div>
    </form>
  </div>

  <!-- ====== FILTROS VISUALES (no recarga) ====== -->
  <div class="form-box">
    <div class="filtros-visual-grid">
      <div>
        <label class="fw-bold">Filtrar por carreras (visual)</label>
        <select id="selectCarreras" multiple></select>
        <div class="quick-actions">
          <button type="button" class="btn-mini" id="cliSelTodos">Todos</button>
          <button type="button" class="btn-mini" id="cliSelNinguno">Ninguno</button>
          <button type="button" class="btn-mini" id="cliSelInvertir">Invertir</button>
        </div>
      </div>
      <div>
        <label class="fw-bold">Buscar (visual)</label>
        <input id="buscadorCarrera" type="search" class="form-control" placeholder="Escribe para filtrar...">
      </div>
      <div>
        <label class="fw-bold">Gr치ficas</label>
        <div class="chips">
          <label class="chip active"><input type="checkbox" class="filtro-grafica" value="graficaLineal" checked> L칤nea</label>
          <label class="chip active"><input type="checkbox" class="filtro-grafica" value="graficaBarras" checked> Barras</label>
          <label class="chip active"><input type="checkbox" class="filtro-grafica" value="graficaPastel" checked> Pastel</label>
          <label class="chip active"><input type="checkbox" class="filtro-grafica" value="graficaGauss"  checked> Gauss</label>
        </div>
      </div>
      <div class="align-end">
        <button id="btnDescargarPDF" class="btn-admin" type="button">Descargar PDF</button>
      </div>
    </div>
  </div>

  <!-- ====== TABLA ====== -->
  <div class="form-box">
    <div class="tabla-scroll">
      <table class="crud-table" id="tablaGeneraciones">
        <thead>
          <tr>
            <th>Programa</th>
            <th>Ingreso</th>
            <th>Egreso</th>
            <th>Ing H</th>
            <th>Ing M</th>
            <th>Egr Coh H</th>
            <th>Egr Coh M</th>
            <th>Egr Rez H</th>
            <th>Egr Rez M</th>
            <th>Tit H</th>
            <th>Tit M</th>
            <th>DGP H</th>
            <th>DGP M</th>
            <th>Tasa %</th>
          </tr>
        </thead>
        <tbody>
          {% for g in generaciones %}
            {% firstof g.programa_antiguo.nombre g.programa_nuevo.nombre as prog_nombre %}
            <tr data-programa="{{ prog_nombre }}">
              <td>{{ prog_nombre }}</td>
              <td>{{ g.fecha_ingreso|date:"Y-m-d" }}</td>
              <td>{{ g.fecha_egreso|date:"Y-m-d" }}</td>
              <td>{{ g.ingreso_hombres }}</td>
              <td>{{ g.ingreso_mujeres }}</td>
              <td>{{ g.egresados_cohorte_h }}</td>
              <td>{{ g.egresados_cohorte_m }}</td>
              <td>{{ g.egresados_rezagados_h }}</td>
              <td>{{ g.egresados_rezagados_m }}</td>
              <td>{{ g.titulados_h }}</td>
              <td>{{ g.titulados_m }}</td>
              <td>{{ g.registrados_dgp_h }}</td>
              <td>{{ g.registrados_dgp_m }}</td>
              <td>{{ g.tasa_titulacion|floatformat:2 }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="14">No hay datos para los filtros seleccionados.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- ====== GR츼FICAS ====== -->
  <div class="graficas-container">
    <canvas id="graficaLineal" class="grafica"></canvas>
    <canvas id="graficaBarras" class="grafica"></canvas>
    <canvas id="graficaPastel" class="grafica"></canvas>
    <canvas id="graficaGauss"  class="grafica"></canvas>
  </div>
</div>

<!-- Datos para JS -->
<script>
  const datosGeneraciones = JSON.parse('{{ generaciones_json|escapejs }}');
  console.log('datosGeneraciones:', datosGeneraciones);
</script>

{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/titulados_historico_actual.js' %}"></script>
{% endblock %}
