{% extends "base_admin.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/matricula_por_cuatrimestre.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>

<div class="admin-panel" id="pdfArea">
  <h2 class="titulo-vista">üìò Matr√≠cula por Cuatrimestre</h2>

  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Filtros -->
  <form method="get" class="filtros no-print">
    <div class="filtro-item">
      <label for="ciclo">Ciclo</label>
      <select name="ciclo" id="ciclo" class="choices-select">
        <option value="Todos">Todos</option>
        {% for c in ciclos %}
          <option value="{{ c.id }}" {% if filtro_ciclo == c.id|stringformat:"s" %}selected{% endif %}>
            {{ c.periodo.nombre }} {{ c.ciclo.anio }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="filtro-item">
      <label for="tipo_programa">Tipo de Programa</label>
      <select name="tipo_programa" id="tipo_programa" class="choices-select">
        <option value="antiguo" {% if tipo_programa == 'antiguo' %}selected{% endif %}>Antiguo</option>
        <option value="nuevo" {% if tipo_programa == 'nuevo' %}selected{% endif %}>Nuevo</option>
      </select>
    </div>

    <div class="filtro-item">
      <label for="programa">Programa</label>
      <select name="programa" id="programa" class="choices-select">
        <option value="Todos">Todos</option>
        {% for p in programas %}
          <option value="{{ p.id }}" {% if filtro_programa == p.id|stringformat:"s" %}selected{% endif %}>{{ p.nombre }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="filtro-actions">
      <button type="submit" class="btn-admin">Aplicar filtros</button>
      <a href="?" class="btn-outline">Limpiar</a>
    </div>
  </form>

  <!-- Acciones -->
  <div class="acciones no-print">
    <button type="button" id="btnDescargarPDF" class="btn-admin">
      ‚¨áÔ∏è Descargar PDF
    </button>

    <div class="acciones__right">
      <a href="{% url 'descargar_plantilla_matricula_cuatrimestre' %}" class="btn-success">
        ‚¨áÔ∏è Plantilla CSV
      </a>
      <form action="{% url 'subir_csv_matricula_cuatrimestre' %}" method="post" enctype="multipart/form-data" class="upload-inline">
        {% csrf_token %}
        <input type="file" name="archivo_csv" class="file-input" required>
        <button type="submit" class="btn-warning">Subir CSV</button>
      </form>
    </div>
  </div>

  <!-- Tabla -->
  <div class="contenedor-tabla">
    <table class="crud-table">
      <thead>
        <tr>
          <th>Programa</th>
          <th>Periodo</th>
          <th class="text-end">Cantidad</th>
        </tr>
      </thead>
      <tbody>
        {% for fila in tabla %}
          <tr>
            <td class="text-left">{{ fila.programa }}</td>
            <td><span class="badge">{{ fila.periodo }}</span></td>
            <td class="text-end">{{ fila.cantidad }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="3" class="text-center text-muted">No hay registros disponibles</td></tr>
        {% endfor %}
      </tbody>
      <tfoot>
      <tr>
        <td colspan="2" class="text-right"><strong>Total</strong></td>
        <td class="text-end">{{ total_general }}</td>
      </tr>
      </tfoot>
    </table>
  </div>

  <!-- Checks de gr√°ficas (mostrar/ocultar) -->
  <div class="graf-controls no-print">
    <label><input type="checkbox" class="mc-chk" value="barras" checked> Barras</label>
    <label><input type="checkbox" class="mc-chk" value="linea" checked> L√≠nea</label>
    <label><input type="checkbox" class="mc-chk" value="pastel" checked> Pastel</label>
    <label><input type="checkbox" class="mc-chk" value="gauss" checked> Gauss</label>
    <span class="nota">* Solo muestran/ocultan; los datos ya vienen filtrados.</span>
  </div>

  <!-- Contenedor para pasar datos al JS externo -->
  <div id="contenedorGraficas" data-grafica-json='{{ datos_grafica|escapejs }}'></div>

  <!-- Gr√°ficas -->
  <section class="graficas">
    <div class="grafica-card" id="box-barras">
      <div class="grafica-title">Barras</div>
      <canvas id="graficaBarras"></canvas>
    </div>
    <div class="grafica-card" id="box-linea">
      <div class="grafica-title">L√≠nea</div>
      <canvas id="graficaLinea"></canvas>
    </div>
    <div class="grafica-card" id="box-pastel">
      <div class="grafica-title">Pastel</div>
      <canvas id="graficaPastel"></canvas>
    </div>
    <div class="grafica-card" id="box-gauss">
      <div class="grafica-title">Gauss (suavizado)</div>
      <canvas id="graficaGauss"></canvas>
    </div>
  </section>
</div>

{% if aviso_tipo_programa %}
  <div class="alert alert-warning mb-3 no-print">{{ aviso_tipo_programa }}</div>
{% endif %}
{% if sin_datos %}
  <div class="alert alert-info mb-3 no-print">No hay datos que coincidan con los filtros seleccionados.</div>
{% endif %}

<!-- Librer√≠as (orden importa) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/choices.js@10.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

<!-- Datos para JS (2 v√≠as) -->
<script>
  // 1) Global
  window.MPC_DATOS = {{ datos_grafica|safe }};
</script>
<!-- 2) data-atributo -->
<div id="contenedorGraficas" data-grafica-json='{{ datos_grafica|escapejs }}'></div>

<!-- Tu JS (con rompe-cach√©) -->
<script src="{% static 'js/matricula_por_cuatrimestre.js' %}?v={% now 'U' %}"></script>

<!-- (Opcional) Asegura altura visible de los canvas -->
<style>
  #box-barras canvas, #box-linea canvas, #box-pastel canvas, #box-gauss canvas,
  #graficaBarras, #graficaLinea, #graficaPastel, #graficaGauss,
  #chBar, #chLine, #chPie, #chGauss {
    min-height: 280px !important;
  }
</style>

{% endblock %}
