{% extends 'base_admin.html' %}
{% load static %}
<style>
  body { background-color: #f5f8fc; font-family: 'Segoe UI', sans-serif; }
  h1 { text-align: center; margin: 30px 0 20px; font-size: 30px; font-weight: bold; color: #2c3e50; }
  .btn { font-weight: 600; border-radius: 8px; padding: 8px 18px; margin: 6px 5px 6px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.08); transition: 0.2s ease; }
  .btn:hover { opacity: .95; transform: scale(1.03); }
  .btn-primary{ background:#007bff; color:#fff; }
  .btn-secondary{ background:#6c757d; color:#fff; }
  .btn-success{ background:#28a745; color:#fff; }
  .btn-outline-secondary{ border:1px solid #6c757d; color:#6c757d; background:transparent; }
  .btn-danger{ background:#dc3545; color:#fff; }
  .container-fluid{ padding:0 30px; }
  .card{ border:none; border-radius:12px; background:#fff; box-shadow:0 4px 12px rgba(0,0,0,.06); margin-bottom:30px; }
  .card-header{ background:#fff; font-weight:600; text-align:center; font-size:1.1rem; border-bottom:1px solid #e0e0e0; padding:12px; }
  .card-body{ padding:20px; }
  .card-body canvas{ display:block; margin:auto; height:250px !important; }
  .form-inline{ display:flex; align-items:center; flex-wrap:wrap; gap:15px; }
  .form-check-inline{ margin-right:12px; }
  .table{ font-size:.9rem; text-align:center; background:#fff; border-radius:8px; }
  .table th{ background:#e9f5ff; color:#333; font-weight:bold; }
  .table td,.table th{ padding:12px; vertical-align:middle; }
  .text-center{ text-align:center; margin-top:30px; }
  @media (max-width: 768px){
    .form-inline{ flex-direction:column; align-items:flex-start; }
    .form-inline > *{ margin-bottom:8px; }
    .btn{ width:100%; text-align:center; }
    .card-body canvas{ width:100% !important; }
  }
</style>

{% block title %}Reprobación y Deserción{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/indicadores_generales.css' %}">

<h1>📉 Reprobación y Deserción</h1>

{% if mensaje %}
  <div class="alert alert-success">{{ mensaje|safe }}</div>
{% endif %}

<div class="container-fluid">

  <!-- Botones -->
  <div class="row mb-4">
    <div class="col-md-6">
      <a href="{% url 'descargar_plantilla_indicadores' %}" class="btn btn-primary">
        <i class="fas fa-download"></i> Descargar plantilla
      </a>
      <form method="POST" action="{% url 'cargar_indicadores_generales' %}" enctype="multipart/form-data" class="d-inline">
        {% csrf_token %}
        <input type="file" name="archivo_csv" class="d-none" id="fileInput" accept=".csv" required>
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">
          <i class="fas fa-upload"></i> Subir CSV
        </button>
        <button type="submit" class="btn btn-success ml-2 d-none" id="submitBtn">Procesar</button>
      </form>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <form method="GET" class="form-inline">
            <label class="mr-2"><strong>Ciclo:</strong></label>
            <select id="filtroAnio" name="filtro_anio" class="form-control">
              <option value="Todos">Todos</option>
              {% for anio in anios %}
                <option value="{{ anio }}" {% if anio == request.GET.filtro_anio %}selected{% endif %}>{{ anio }}</option>
              {% endfor %}
            </select>
          </form>
        </div>
        <div class="col-md-6">
          <div class="form-inline float-right">
            <label class="mr-2"><strong>Gráficas:</strong></label>
            <div class="form-check form-check-inline">
              <input class="form-check-input grafica-check" type="checkbox" value="barras" id="checkBarras" checked>
              <label class="form-check-label" for="checkBarras">Barras</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input grafica-check" type="checkbox" value="linea" id="checkLinea" checked>
              <label class="form-check-label" for="checkLinea">Línea</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input grafica-check" type="checkbox" value="pastel" id="checkPastel" checked>
              <label class="form-check-label" for="checkPastel">Pastel</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input grafica-check" type="checkbox" value="gauss" id="checkGauss" checked>
              <label class="form-check-label" for="checkGauss">Gauss</label>
            </div>
            <button id="aplicarFiltros" type="button" class="btn btn-sm btn-primary ml-2">Aplicar</button>
            <button id="resetFiltros" type="button" class="btn btn-sm btn-outline-secondary ml-1">Reset</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ⬆️ Filtros | ⬇️ TABLA (movida aquí) -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="m-0">📋 Detalle por Ciclo</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-bordered" id="tablaDetalle">
          <thead class="thead-light">
            <tr>
              <th>Ciclo</th>
              <th>Matrícula</th>
              <th>Deserción</th>
              <th>Reprobación</th>
              <th>Egresados</th>
              <th>% Deserción</th>
              <th>% Reprobación</th>
            </tr>
          </thead>
          <tbody>
            {% for fila in detalle_ciclos %}
            <tr>
              <td>{{ fila.ciclo }}</td>
              <td>{{ fila.matricula }}</td>
              <td>{{ fila.desercion }}</td>
              <td>{{ fila.reprobacion }}</td>
              <td>{{ fila.egresados }}</td>
              <td>{{ fila.porcentaje_desercion }}%</td>
              <td>{{ fila.porcentaje_reprobacion }}%</td>
            </tr>
            {% empty %}
            <tr><td colspan="7" class="text-muted">Sin registros</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="text-muted small mt-2" id="msgSinDatosTabla" style="display:none">No hay datos que coincidan con el ciclo seleccionado.</div>
    </div>
  </div>

  <!-- Gráficas (quedan debajo de la tabla) -->
  <div class="row">
    <div class="col-lg-6 mb-4">
      <div class="card h-100" id="box-barras">
        <div class="card-header"><h5 class="m-0">📊 Gráfico de Barras</h5></div>
        <div class="card-body"><canvas id="graficaBarras" height="250"></canvas></div>
      </div>
    </div>
    <div class="col-lg-6 mb-4">
      <div class="card h-100" id="box-linea">
        <div class="card-header"><h5 class="m-0">📈 Gráfico de Línea</h5></div>
        <div class="card-body"><canvas id="graficaLinea" height="250"></canvas></div>
      </div>
    </div>
    <div class="col-lg-6 mb-4">
      <div class="card h-100" id="box-pastel">
        <div class="card-header"><h5 class="m-0">🥧 Gráfico de Pastel</h5></div>
        <div class="card-body"><canvas id="graficaPastel" height="250"></canvas></div>
      </div>
    </div>
    <div class="col-lg-6 mb-4">
      <div class="card h-100" id="box-gauss">
        <div class="card-header"><h5 class="m-0">📉 Campana de Gauss</h5></div>
        <div class="card-body"><canvas id="graficaGauss" height="250"></canvas></div>
      </div>
    </div>
  </div>

  <!-- Botón PDF -->
  <div class="text-center mb-4">
    <button id="btnDescargarPDF" class="btn btn-danger">
      <i class="fas fa-file-pdf"></i> Descargar PDF
    </button>
  </div>

</div>

<!-- Datos para JS -->
<script id="datosGraficas" type="application/json">
{
  "desercion": "{{ datos_graficas.desercion|default:'0' }}",
  "reprobacion": "{{ datos_graficas.reprobacion|default:'0' }}"
}
</script>

<!-- JS libs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// ====== Inicial ======
document.addEventListener("DOMContentLoaded", function() {
  const datos = JSON.parse(document.getElementById('datosGraficas').textContent);
  const charts = {};

  // --- Filtro de TABLA por ciclo (cliente) ---
  function filtrarTabla(){
    const ciclo = document.getElementById('filtroAnio')?.value || 'Todos';
    const rows = document.querySelectorAll('#tablaDetalle tbody tr');
    let visibles = 0;
    rows.forEach(tr => {
      const celdas = tr.querySelectorAll('td');
      if (!celdas.length) return;
      const cicloFila = (celdas[0].textContent || '').trim();
      const show = (ciclo === 'Todos' || cicloFila === ciclo);
      tr.style.display = show ? '' : 'none';
      if (show) visibles++;
    });
    const msg = document.getElementById('msgSinDatosTabla');
    if (msg) msg.style.display = visibles ? 'none' : '';
  }

  // --- Gráficas ---
  function renderGraficas(seleccionadas) {
    const valores = [
      parseFloat(datos.desercion) || 0,
      parseFloat(datos.reprobacion) || 0
    ];
    const labels = ['Deserción', 'Reprobación'];
    const colors = ['#FF6384', '#36A2EB'];

    // Destruir existentes
    Object.values(charts).forEach(c => c && c.destroy());

    // Mostrar/ocultar contenedores
    ['barras','linea','pastel','gauss'].forEach(tipo => {
      const box = document.getElementById(`box-${tipo}`);
      if (box) box.style.display = seleccionadas.includes(tipo) ? 'block' : 'none';
    });

    // Barras
    if (seleccionadas.includes('barras')){
      charts.barras = new Chart(document.getElementById('graficaBarras'), {
        type: 'bar',
        data: { labels, datasets: [{ label:'Porcentaje (%)', data: valores, backgroundColor: colors, borderColor: colors, borderWidth: 1 }] },
        options: { responsive:true, plugins:{ legend:{display:true}, datalabels:{ anchor:'end', align:'top', formatter:v=>v+'%', font:{weight:'bold'} } } },
        plugins: [ChartDataLabels]
      });
    }
    // Línea
    if (seleccionadas.includes('linea')){
      charts.linea = new Chart(document.getElementById('graficaLinea'), {
        type: 'line',
        data: { labels, datasets: [{ label:'Porcentaje (%)', data: valores, borderColor:'#4BC0C0', backgroundColor:'rgba(75,192,192,.2)', fill:true, tension:.4 }] },
        options: { responsive:true, plugins:{ legend:{display:true}, datalabels:{ anchor:'end', align:'top', formatter:v=>v+'%', font:{weight:'bold'} } } },
        plugins: [ChartDataLabels]
      });
    }
    // Pastel
    if (seleccionadas.includes('pastel')){
      charts.pastel = new Chart(document.getElementById('graficaPastel'), {
        type: 'pie',
        data: { labels, datasets:[{ data: valores, backgroundColor: colors, borderColor:'#fff', borderWidth:2 }] },
        options: { responsive:true, plugins:{ legend:{display:true}, datalabels:{ formatter:v=>v+'%', font:{weight:'bold'} } } },
        plugins: [ChartDataLabels]
      });
    }
    // Gauss
    if (seleccionadas.includes('gauss')){
      const gauss = data => {
        const mean = data.reduce((a,b)=>a+b,0)/data.length;
        const sd = Math.sqrt(data.reduce((a,b)=>a+Math.pow(b-mean,2),0)/data.length) || 1;
        return data.map(x => Math.exp(-Math.pow(x-mean,2)/(2*Math.pow(sd,2))));
      };
      charts.gauss = new Chart(document.getElementById('graficaGauss'), {
        type: 'line',
        data: { labels, datasets:[{ label:'Distribución Gaussiana', data: gauss(valores), borderColor:'#9966FF', backgroundColor:'rgba(153,102,255,.2)', fill:true, tension:.4 }] },
        options: { responsive:true }
      });
    }
  }

  // --- Acciones de filtros ---
  document.getElementById('aplicarFiltros')?.addEventListener('click', () => {
    const seleccionadas = Array.from(document.querySelectorAll('.grafica-check:checked')).map(x=>x.value);
    filtrarTabla();
    renderGraficas(seleccionadas);
  });
  document.getElementById('resetFiltros')?.addEventListener('click', () => {
    document.querySelectorAll('.grafica-check').forEach(cb => cb.checked = true);
    const sel = document.getElementById('filtroAnio'); if (sel) sel.value = 'Todos';
    filtrarTabla();
    renderGraficas(['barras','linea','pastel','gauss']);
  });
  document.getElementById('filtroAnio')?.addEventListener('change', () => {
    filtrarTabla();
  });

  // --- Exportar PDF (gráficas visibles) ---
  document.getElementById('btnDescargarPDF')?.addEventListener('click', async () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(16); doc.text("Reporte de Indicadores", 105, 15, { align: "center" });
    const graficas = ['box-barras','box-linea','box-pastel','box-gauss'];
    let y = 25;
    for (const id of graficas){
      const box = document.getElementById(id);
      if (!box || box.style.display === 'none') continue;
      const canvas = box.querySelector('canvas'); if (!canvas) continue;
      const imgData = await html2canvas(canvas, { scale: 2 }).then(c => c.toDataURL('image/png'));
      const width = 180; const height = canvas.offsetHeight * (width / canvas.offsetWidth);
      if (y + height > doc.internal.pageSize.getHeight() - 10){ doc.addPage(); y = 15; }
      doc.addImage(imgData, 'PNG', 15, y, width, height); y += height + 10;
    }
    doc.save('reporte_indicadores.pdf');
  });

  // Primera carga
  filtrarTabla();
  renderGraficas(['barras','linea','pastel','gauss']);
});
</script>

{% endblock %}
