{% extends 'base_admin.html' %}
{% load static %}
{% block title %}Evaluaci칩n Docente por Cuatrimestre{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/evaluacion_docente.css' %}">

<h2 class="titulo-principal">游늵 Evaluaci칩n Docente por Cuatrimestre</h2>



<!-- Formulario de captura -->
<form method="POST">
    {% csrf_token %}
    <div class="row justify-content-center">
        <div class="col-md-4">
            <label><strong>Ciclo Periodo</strong></label>
            <select name="ciclo_periodo" class="form-control" required>
                <option value="">Seleccione un ciclo</option>
                {% for periodo in periodos %}
                    <option value="{{ periodo.id }}">{{ periodo }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label><strong>Promedio General</strong></label>
            <input type="number" name="promedio_general" class="form-control" step="0.01" placeholder="Ej. 8.5" required>
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn-guardar w-100">Guardar</button>
        </div>
    </div>
</form>

<!-- Tabla de datos -->
<div class="table-responsive mt-4">
    <table class="table table-bordered table-evaluacion text-center">
        <thead class="table-primary">
            <tr>
                <th>Ciclo Periodo</th>
                <th>Promedio General</th>
            </tr>
        </thead>
        <tbody>
            {% for item in datos %}
            <tr>
                <td>{{ item.ciclo_periodo }}</td>
                <td>{{ item.promedio_general }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="2">No hay registros a칰n.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Filtros -->
<div class="mt-5">
    <h5>游꿢 Filtros de visualizaci칩n</h5>

    <div class="form-check">
        <input type="checkbox" class="form-check-input" value="linea" checked>
        <label class="form-check-label">Gr치fico de L칤nea</label>
    </div>
    <div class="form-check">
        <input type="checkbox" class="form-check-input" value="barras" checked>
        <label class="form-check-label">Gr치fico de Barras</label>
    </div>
    <div class="form-check">
        <input type="checkbox" class="form-check-input" value="pastel" checked>
        <label class="form-check-label">Gr치fico de Pastel</label>
    </div>
    <div class="form-check">
        <input type="checkbox" class="form-check-input" value="gauss" checked>
        <label class="form-check-label">Gr치fico Gaussiano</label>
    </div>

    <!-- Selector de ciclos -->
    <div class="mt-3">
        <label><strong>Ciclos a mostrar:</strong></label>
        <select id="filtro-ciclos" class="form-control" multiple size="5" style="min-height: 130px;">
            {% for p in periodos %}
                <option value="{{ p }}">{{ p }}</option>
            {% endfor %}
        </select>
        <small class="text-muted">Mant칠n presionada Ctrl (o Cmd en Mac) para seleccionar m칰ltiples ciclos</small>
    </div>

    <div class="mt-3">
        <button id="btnAplicar" class="btn btn-primary">Aplicar Filtros</button>
        <button id="btnReset" class="btn btn-secondary">Restablecer</button>
    </div>
</div>

<!-- Gr치ficas -->
<div class="row mt-4">
    <div class="col-md-6" id="grafico-linea-container">
        <h6>游늳 Gr치fico de L칤nea</h6>
        <canvas id="grafico-linea" height="180"></canvas>
    </div>
    <div class="col-md-6" id="grafico-barras-container">
        <h6>游늵 Gr치fico de Barras</h6>
        <canvas id="grafico-barras" height="180"></canvas>
    </div>
    <div class="col-md-6" id="grafico-pastel-container">
        <h6>游볺 Gr치fico de Pastel</h6>
        <canvas id="grafico-pastel" height="180"></canvas>
    </div>
    <div class="col-md-6" id="grafico-gauss-container">
        <h6>游늴 Gr치fico Gaussiano</h6>
        <canvas id="grafico-gauss" height="180"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const etiquetas = {{ etiquetas|safe }};
    const valores = {{ promedios|safe }};

    const charts = {
        linea: new Chart(document.getElementById("grafico-linea"), {
            type: 'line',
            data: {
                labels: etiquetas,
                datasets: [{
                    label: 'Promedio',
                    data: valores,
                    backgroundColor: 'rgba(0, 123, 255, 0.3)',
                    borderColor: 'blue',
                    tension: 0.3
                }]
            },
            options: { responsive: true }
        }),
        barras: new Chart(document.getElementById("grafico-barras"), {
            type: 'bar',
            data: {
                labels: etiquetas,
                datasets: [{
                    label: 'Promedio',
                    data: valores,
                    backgroundColor: 'rgba(40, 167, 69, 0.6)',
                    borderColor: 'green',
                    borderWidth: 1
                }]
            },
            options: { responsive: true }
        }),
        pastel: new Chart(document.getElementById("grafico-pastel"), {
            type: 'pie',
            data: {
                labels: etiquetas,
                datasets: [{
                    data: valores,
                    backgroundColor: etiquetas.map((_, i) => `hsl(${i * 60}, 70%, 70%)`)
                }]
            },
            options: { responsive: true }
        }),
        gauss: new Chart(document.getElementById("grafico-gauss"), {
            type: 'line',
            data: {
                labels: etiquetas,
                datasets: [{
                    label: 'Distribuci칩n Gaussiana',
                    data: calcularGauss(valores),
                    borderColor: 'purple',
                    backgroundColor: 'rgba(123, 0, 255, 0.2)',
                    tension: 0.4
                }]
            },
            options: { responsive: true }
        })
    };

    // Filtros
    document.getElementById("btnAplicar").addEventListener("click", () => {
        const seleccionados = [...document.querySelectorAll('#filtro-ciclos option:checked')].map(opt => opt.value);
        const checks = [...document.querySelectorAll('.form-check-input')];

        // Gr치ficas ON/OFF
        checks.forEach(chk => {
            document.getElementById(`grafico-${chk.value}-container`).style.display = chk.checked ? 'block' : 'none';
        });

        // Filtrar datos
        const nuevasEtiquetas = [], nuevosValores = [];
        etiquetas.forEach((et, i) => {
            if (seleccionados.includes(et)) {
                nuevasEtiquetas.push(et);
                nuevosValores.push(valores[i]);
            }
        });

        // Actualizar gr치ficas
        Object.entries(charts).forEach(([key, chart]) => {
            chart.data.labels = nuevasEtiquetas;
            chart.data.datasets[0].data = key === 'gauss' ? calcularGauss(nuevosValores) : nuevosValores;
            chart.update();
        });
    });

    // Restablecer
    document.getElementById("btnReset").addEventListener("click", () => {
        location.reload();
    });

    function calcularGauss(datos) {
        const prom = datos.reduce((a, b) => a + b, 0) / datos.length;
        const sigma = Math.sqrt(datos.reduce((a, b) => a + (b - prom) ** 2, 0) / datos.length);
        return datos.map(x => Math.exp(-Math.pow(x - prom, 2) / (2 * sigma ** 2)));
    }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

{% endblock %}
