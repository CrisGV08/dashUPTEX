{% extends 'base_admin.html' %}
{% load static %}

{% block title %}Tasa de Titulaci칩n{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/tasa_titulacion.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />

<h2 class="titulo-principal">游늳 Tasa de Titulaci칩n</h2>

{% if messages %}
  <div class="mensajes">
    {% for message in messages %}
      <div class="mensaje">{{ message }}</div>
    {% endfor %}
  </div>
{% endif %}

<!-- Filtros visuales -->
<div class="filtros">
  <div class="filtro">
    <label for="filtro_anio"><strong>Ciclos:</strong></label>
    <select id="filtro_anio" multiple>
      {% for anio in anios %}
        <option value="{{ anio }}">{{ anio }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="filtro">
    <label for="filtro_programa"><strong>Programas:</strong></label>
    <select id="filtro_programa" multiple>
      {% for programa in programas_antiguos %}
        <option value="{{ programa.nombre }}">{{ programa.nombre }}</option>
      {% endfor %}
      {% for programa in programas_nuevos %}
        <option value="{{ programa.nombre }}">{{ programa.nombre }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="filtro">
    <label for="filtro_grafica"><strong>Gr치ficas:</strong></label>
    <select id="filtro_grafica" multiple>
      <option value="linea" selected>L칤nea</option>
      <option value="barras" selected>Barras</option>
      <option value="pastel" selected>Pastel</option>
      <option value="gauss" selected>Campana de Gauss</option>
    </select>
  </div>

  <div class="acciones-filtros">
    <button id="aplicarFiltros" class="btn-guardar" type="button">Aplicar filtros</button>
    <button id="resetFiltros" class="btn-guardar btn-secundario" type="button">Restablecer</button>
    <button id="btnDescargarPDF" class="btn-guardar" type="button">游늯 Descargar PDF</button>
  </div>
</div>

<!-- Carga/descarga de Excel -->
<form method="post" enctype="multipart/form-data" action="{% url 'subir_excel_tasa_titulacion' %}" class="form-excel">
  {% csrf_token %}
  <input type="file" name="archivo_excel" accept=".xlsx" required>
  <button type="submit" class="btn-guardar">游닋 Subir Excel</button>
  <a href="{% url 'descargar_plantilla_tasa_titulacion' %}" class="btn-guardar">游닌 Descargar Plantilla</a>
</form>

<!-- Contenido exportable (tabla + gr치ficas) -->
<div id="seccionDescargable">
  <!-- Tabla editable -->
  <form method="post" class="form-tabla">
    {% csrf_token %}
    <div class="table-responsive">
      <table class="tabla-titulacion">
        <thead>
          <tr>
            <th>Programa</th>
            <th>A침o Ingreso</th>
            <th>Matr칤cula</th>
            <th>Egresados</th>
            <th>Titulados</th>
            <th>Eficiencia Terminal (%)</th>
            <th>Tasa Titulaci칩n (%)</th>
            <th>Guardar</th>
          </tr>
        </thead>
        <tbody>
          {% for registro in registros %}
          <tr>
            <td>
              {% if registro.programa_antiguo %}
                {{ registro.programa_antiguo.nombre }}
              {% elif registro.programa_nuevo %}
                {{ registro.programa_nuevo.nombre }}
              {% else %}
                Sin programa
              {% endif %}
            </td>
            <td>{{ registro.anio_ingreso }}</td>
            <td>
              <input type="number" min="0" step="1"
                     name="matricula_{{ registro.id }}"
                     value="{{ registro.matricula_ingreso }}">
            </td>
            <td>
              <input type="number" min="0" step="1"
                     name="egresados_{{ registro.id }}"
                     value="{{ registro.egresados }}">
            </td>
            <td>
              <input type="number" min="0" step="1"
                     name="titulados_{{ registro.id }}"
                     value="{{ registro.titulados }}">
            </td>
            <td><span class="num">{{ registro.eficiencia_terminal_porcentaje }}</span>%</td>
            <td><span class="num">{{ registro.tasa_titulacion }}</span>%</td>
            <td>
              <button type="submit" name="guardar" value="{{ registro.id }}" class="btn-guardar">Guardar</button>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="8" class="vacio">No hay registros disponibles.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </form>

  <!-- Gr치ficas -->
  <div class="contenedor-graficas">
    <div class="grafica"><canvas id="graficaLinea"></canvas></div>
    <div class="grafica"><canvas id="graficaBarras"></canvas></div>
    <div class="grafica"><canvas id="graficaPastel"></canvas></div>
    <div class="grafica"><canvas id="graficaGauss"></canvas></div>
  </div>
</div>

<!-- Datos para JS -->
<script type="application/json" id="jsonDatos">
  {{ datos_json|safe }}
</script>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<script src="{% static 'js/tasa_de_titulacion.js' %}"></script>
{% endblock %}
