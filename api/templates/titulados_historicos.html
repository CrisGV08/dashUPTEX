{% extends 'base_admin.html' %}
{% load static %}

{% block title %}Titulados HistÃ³ricos{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/titulados_historicos.css' %}">

<!-- LibrerÃ­as para grÃ¡ficas y exportaciÃ³n -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<div class="admin-panel">
  <h1 class="titulo">ðŸ“˜ Titulados HistÃ³ricos</h1>

  {% if messages %}
    {% for message in messages %}
      <div class="mensaje-exito">{{ message|safe }}</div>
    {% endfor %}
  {% endif %}

  <!-- Subir / Descargar Excel -->
  <div class="form-box">
    <form method="POST" enctype="multipart/form-data" action="{% url 'titulados_historicos' %}">
      {% csrf_token %}
      <h3>ðŸ“¤ Subir Archivo Excel</h3>
      <p class="text-muted" style="margin:4px 0 10px;">
        Acepta formato estÃ¡ndar (<code>programa_tipo</code>, <code>programa_id</code>, â€¦) o legado (<code>PROGRAMA EDUCATIVO</code>, â€¦).
      </p>
      <input type="file" name="archivo_excel" accept=".xlsx" required>
      <div style="margin-top:10px">
        <button type="submit" class="btn-admin btn-icon">â¤´ Cargar Datos</button>
      </div>
    </form>

    <form method="GET" action="{% url 'descargar_plantilla_titulados_historicos' %}">
      <h3>ðŸ“¥ Descargar Plantilla</h3>
      <p class="text-muted" style="margin:4px 0 10px;">Incluye hoja de instrucciones y catÃ¡logo de programas.</p>
      <button type="submit" class="btn-admin btn-icon">â¬‡ Descargar Excel</button>
    </form>
  </div>

  <!-- Tabla con sticky header -->
  <div class="contenedor-tabla">
    <h3 class="subtitulo">ðŸ“‹ Datos Cargados</h3>
    <div>
      <table class="tabla-admin is-comfy">
        <thead>
          <tr>
            <th>Programa</th>
            <th>AÃ±o Ingreso</th>
            <th>AÃ±o Egreso</th>
            <th>Tit. Hombres</th>
            <th>Tit. Mujeres</th>
            <th>Reg. DGP H</th>
            <th>Reg. DGP M</th>
            <th>Total Titulados</th>
            <th>Total DGP</th>
          </tr>
        </thead>
        <tbody>
          {% for r in registros %}
            <tr>
              <td>
                {% if r.programa_antiguo %}{{ r.programa_antiguo.nombre }}
                {% elif r.programa_nuevo %}{{ r.programa_nuevo.nombre }}
                {% else %}No definido{% endif %}
              </td>
              <td>{{ r.anio_ingreso }}</td>
              <td>{{ r.anio_egreso }}</td>
              <td>{{ r.titulados_hombres }}</td>
              <td>{{ r.titulados_mujeres }}</td>
              <td>{{ r.registrados_dgp_h }}</td>
              <td>{{ r.registrados_dgp_m }}</td>
              <td>{{ r.total_titulados }}</td>
              <td>{{ r.total_dgp }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="9">
                <div class="empty">Sin datos para mostrar. Carga un archivo Excel o ajusta tus filtros.</div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Filtros (cliente, no recarga) -->
  <div class="filtros" id="filtrosTH">
    <div>
      <label for="fltAnio"><strong>AÃ±os:</strong></label>
      <select id="fltAnio" multiple></select>
    </div>

    <div>
      <label for="fltPrograma"><strong>Programas:</strong></label>
      <select id="fltPrograma" multiple style="min-width:220px"></select>
    </div>

    <div>
      <label for="fltBuscar"><strong>Buscar:</strong></label>
      <input id="fltBuscar" type="text" placeholder="Nombre de programaâ€¦">
    </div>

    <div>
      <label><strong>Titulados (mÃ­nâ€“mÃ¡x):</strong></label>
      <div style="display:flex; gap:8px;">
        <input id="fltTitMin" type="number" placeholder="mÃ­n" style="width:100px">
        <input id="fltTitMax" type="number" placeholder="mÃ¡x" style="width:100px">
      </div>
    </div>

    <div style="display:flex; gap:10px;">
      <button type="button" class="btn-admin" id="btnAplicar">Aplicar</button>
      <button type="button" class="btn-admin" id="btnReset">Reset</button>
    </div>
  </div>

  <!-- ExportaciÃ³n -->
  <div class="filtros">
    <button class="btn-exportar btn-icon" id="btnDescargarPDF" type="button">ðŸ“„ Exportar PDF</button>
  </div>

  <!-- GrÃ¡ficas -->
  <div class="graficas" id="seccionDescargable">
    <div class="chart-card">
      <div class="chart-card__title">ðŸ“ˆ Titulados totales (lÃ­nea)</div>
      <canvas id="gLinea"></canvas>
    </div>

    <div class="chart-card">
      <div class="chart-card__title">ðŸ“Š Titulados H/M (apilado) + DGP (lÃ­nea)</div>
      <canvas id="gBarras"></canvas>
    </div>

    <div class="chart-card">
      <div class="chart-card__title">ðŸ¥§ ParticipaciÃ³n por programa (Top 10 + Otros)</div>
      <canvas id="gPastel"></canvas>
    </div>

    <div class="chart-card">
      <div class="chart-card__title">ðŸ“‰ DistribuciÃ³n tipo Gauss (titulados)</div>
      <canvas id="gGauss"></canvas>
    </div>
  </div>
</div>

<!-- Datos para JS (seguro con json_script) + fallback compat -->
{{ datos_json|json_script:"datosTH" }}
<script id="jsonDatos" type="application/json">{{ datos_json|safe }}</script>

<!-- JS de pÃ¡gina (con cache-busting por timestamp para evitar cachÃ©) -->
<script src="{% static 'js/titulados_historicos.js' %}?v={{ now|date:'U' }}"></script>

<!-- ExportaciÃ³n a PDF de la secciÃ³n de grÃ¡ficas -->
<script>
  document.getElementById('btnDescargarPDF')?.addEventListener('click', async () => {
    const cont = document.getElementById('seccionDescargable');
    await html2pdf().set({
      margin: [10,10,10,10],
      filename: 'titulados_historicos.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    }).from(cont).save();
  });
</script>
{% endblock %}
