{% extends 'base_admin.html' %}
{% load static %}

{% block title %}Titulados Hist√≥ricos{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/titulados_historicos.css' %}">

<!-- Librer√≠as para gr√°ficas y exportaci√≥n -->
<!-- UMD evita problemas de nombre global -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<div class="admin-panel">
  <h1 class="titulo">üìò Titulados Hist√≥ricos</h1>

  {% if messages %}
    {% for message in messages %}
      <div class="mensaje-exito">{{ message|safe }}</div>
    {% endfor %}
  {% endif %}

  <!-- Subir / Descargar Excel -->
  <div class="form-box">
    <form method="POST" enctype="multipart/form-data" action="{% url 'titulados_historicos' %}">
      {% csrf_token %}
      <h3>üì§ Subir Archivo Excel</h3>
      <p class="text-muted" style="margin:4px 0 10px;">
        Acepta formato est√°ndar (<code>programa_tipo</code>, <code>programa_id</code>, ‚Ä¶) o legado (<code>PROGRAMA EDUCATIVO</code>, ‚Ä¶).
      </p>
      <input type="file" name="archivo_excel" accept=".xlsx" required>
      <div style="margin-top:10px">
        <button type="submit" class="btn-admin btn-icon">‚§¥ Cargar Datos</button>
      </div>
    </form>

    <form method="GET" action="{% url 'descargar_plantilla_titulados_historicos' %}">
      <h3>üì• Descargar Plantilla</h3>
      <p class="text-muted" style="margin:4px 0 10px;">Incluye hoja de instrucciones y cat√°logo de programas.</p>
      <button type="submit" class="btn-admin btn-icon">‚¨á Descargar Excel</button>
    </form>
  </div>

  <!-- Tabla con sticky header -->
  <div class="contenedor-tabla">
    <h3 class="subtitulo">üìã Datos Cargados</h3>
    <div>
      <table class="tabla-admin is-comfy">
        <thead>
          <tr>
            <th>Programa</th>
            <th>A√±o Ingreso</th>
            <th>A√±o Egreso</th>
            <th>Tit. Hombres</th>
            <th>Tit. Mujeres</th>
            <th>Reg. DGP H</th>
            <th>Reg. DGP M</th>
            <th>Total Titulados</th>
            <th>Total DGP</th>
          </tr>
        </thead>
        <tbody>
          {% for r in registros %}
            <tr>
              <td>
                {% if r.programa_antiguo %}{{ r.programa_antiguo.nombre }}
                {% elif r.programa_nuevo %}{{ r.programa_nuevo.nombre }}
                {% else %}No definido{% endif %}
              </td>
              <td>{{ r.anio_ingreso }}</td>
              <td>{{ r.anio_egreso }}</td>
              <td>{{ r.titulados_hombres }}</td>
              <td>{{ r.titulados_mujeres }}</td>
              <td>{{ r.registrados_dgp_h }}</td>
              <td>{{ r.registrados_dgp_m }}</td>
              <td>{{ r.titulados_hombres|add:r.titulados_mujeres }}</td>
              <td>{{ r.registrados_dgp_h|add:r.registrados_dgp_m }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="9">
                <div class="empty">Sin datos para mostrar. Carga un archivo Excel o ajusta tus filtros.</div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if page_obj.has_other_pages %}
      <div class="paginacion" style="display:flex; gap:8px; justify-content:center; margin-top:12px;">
        {% if page_obj.has_previous %}
          <a class="btn-admin" href="?page={{ page_obj.previous_page_number }}">‚Üê Anterior</a>
        {% endif %}
        <span class="text-muted" style="align-self:center;">P√°gina {{ page_obj.number }} de {{ paginator.num_pages }}</span>
        {% if page_obj.has_next %}
          <a class="btn-admin" href="?page={{ page_obj.next_page_number }}">Siguiente ‚Üí</a>
        {% endif %}
      </div>
    {% endif %}
  </div>

  <!-- Filtros (cliente, no recarga) -->
  <div class="filtros" id="filtrosTH">
  <div>
    <label for="fltAnio"><strong>A√±os:</strong></label>
    <select id="fltAnio" multiple></select>
  </div>

  <div>
    <label for="fltPrograma"><strong>Programas:</strong></label>
    <select id="fltPrograma" multiple style="min-width:220px"></select>
  </div>

  <div style="display:flex; gap:10px;">
    <button type="button" class="btn-admin" id="btnAplicar">Aplicar</button>
    <button type="button" class="btn-admin" id="btnReset">Reset</button>
  </div>
</div>


  <!-- Exportaci√≥n -->
  <div class="filtros">
    <button class="btn-exportar btn-icon" id="btnDescargarPDF" type="button">üìÑ Exportar PDF</button>
  </div>

  <!-- Gr√°ficas (ahora cada canvas dentro de .chart-area) -->
  <div class="graficas" id="seccionDescargable">
    <div class="chart-card">
      <div class="chart-card__title">üìà Titulados totales (l√≠nea)</div>
      <div class="chart-area"><canvas id="gLinea"></canvas></div>
    </div>

    <div class="chart-card">
      <div class="chart-card__title">üìä Titulados H/M (apilado) + DGP (l√≠nea)</div>
      <div class="chart-area"><canvas id="gBarras"></canvas></div>
    </div>

    <div class="chart-card">
      <div class="chart-card__title">ü•ß Participaci√≥n por programa (Top 10 + Otros)</div>
      <div class="chart-area"><canvas id="gPastel"></canvas></div>
    </div>

    <div class="chart-card">
      <div class="chart-card__title">üìâ Distribuci√≥n tipo Gauss (titulados)</div>
      <div class="chart-area"><canvas id="gGauss"></canvas></div>
    </div>
  </div>
</div>

<!-- Datos para JS (seguro con json_script) + fallback compat -->
{{ datos_json|json_script:"datosTH" }}
<script id="jsonDatos" type="application/json">{{ datos_json|safe }}</script>

<!-- JS de p√°gina (cache-busting real) -->
<script src="{% static 'js/titulados_historicos.js' %}?v={% now 'U' %}"></script>

<!-- Exportaci√≥n a PDF de la secci√≥n de gr√°ficas -->
<script>
  document.getElementById('btnDescargarPDF')?.addEventListener('click', async () => {
    const cont = document.getElementById('seccionDescargable');
    await html2pdf().set({
      margin: [10,10,10,10],
      filename: 'titulados_historicos.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    }).from(cont).save();
  });
</script>
{% endblock %}
