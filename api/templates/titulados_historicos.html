{% extends 'base_admin.html' %}
{% load static %}

{% block title %}Titulados Históricos{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/titulados_historicos.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

<div class="admin-panel">
  <h1 class="titulo">📘 Titulados Históricos</h1>

  {% if messages %}
    {% for message in messages %}
      <div class="mensaje-exito">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <div class="form-box">
    <form method="POST" enctype="multipart/form-data">
      {% csrf_token %}
      <h3>📤 Subir Archivo Excel</h3>
      <input type="file" name="archivo_excel" required>
      <button type="submit" class="btn-admin">Cargar Datos</button>
    </form>

    <form method="GET" action="{% url 'descargar_plantilla_titulados_historicos' %}">
      <h3>📥 Descargar Plantilla</h3>
      <button type="submit" class="btn-admin">Descargar Excel</button>
    </form>
  </div>

  <div class="contenedor-tabla">
    <h3 class="subtitulo">📋 Datos Cargados</h3>
    <table class="tabla-admin">
      <thead>
        <tr>
          <th>Programa</th>
          <th>Año Ingreso</th>
          <th>Año Egreso</th>
          <th>Tit. Hombres</th>
          <th>Tit. Mujeres</th>
          <th>Reg. DGP H</th>
          <th>Reg. DGP M</th>
          <th>Total Titulados</th>
          <th>Total DGP</th>
        </tr>
      </thead>
      <tbody>
        {% for d in datos %}
          <tr>
            <td>
              {% if d.programa_antiguo %}
                {{ d.programa_antiguo.nombre }}
              {% elif d.programa_nuevo %}
                {{ d.programa_nuevo.nombre }}
              {% else %}
                No definido
              {% endif %}
            </td>
            <td>{{ d.anio_ingreso }}</td>
            <td>{{ d.anio_egreso }}</td>
            <td>{{ d.titulados_hombres }}</td>
            <td>{{ d.titulados_mujeres }}</td>
            <td>{{ d.registrados_dgp_h }}</td>
            <td>{{ d.registrados_dgp_m }}</td>
            <td>{{ d.total_titulados }}</td>
            <td>{{ d.total_dgp }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="filtros">
    <h3>🎛️ Filtros</h3>
    <label><input type="checkbox" class="filtro-grafica" value="graficaLinea" checked> Línea</label>
    <label><input type="checkbox" class="filtro-grafica" value="graficaBarras" checked> Barras</label>
    <label><input type="checkbox" class="filtro-grafica" value="graficaPastel" checked> Pastel</label>
    <label><input type="checkbox" class="filtro-grafica" value="graficaGauss" checked> Gaussiana</label>
    <button class="btn-exportar" onclick="exportarPDF()">📄 Exportar PDF</button>
  </div>

  <div class="graficas" id="contenedorGraficas">
    <canvas id="grafica-lineal"></canvas>
    <canvas id="grafica-barras"></canvas>
    <canvas id="grafica-pastel"></canvas>
    <canvas id="grafica-gauss"></canvas>
  </div>
</div>

<script>
  const datosTitulados = {{ datos_json|safe }};
</script>
<script src="{% static 'js/titulados_historicos.js' %}"></script>
{% endblock %}
