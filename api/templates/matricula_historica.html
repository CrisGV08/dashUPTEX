{% extends 'base_admin.html' %}
{% load static %}
{% load custom_tags %}

{% block title %}Matr칤cula Hist칩rica{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/matriculahistoricac.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />

<h2 class="text-center">游늵 Matr칤cula Hist칩rica</h2>
 
<form method="get" class="mb-4 text-center">
    <label for="anio" class="fw-bold">游댍 Filtrar por A침o:</label>
    <select name="anio" id="anio" class="form-select d-inline-block w-auto ms-2" onchange="this.form.submit()">
        <option value="">游늰 Todos</option>
        {% for a in anios %}
            <option value="{{ a }}" {% if anio_seleccionado == a|stringformat:"s" %}selected{% endif %}>{{ a }}</option>
        {% endfor %}
    </select>
</form>


<!-- Formulario -->
<form method="post">
    {% csrf_token %}
    <div class="table-responsive">
        <table class="table table-bordered text-center align-middle table-sm" style="font-size: 13px;">
            <thead>
                <tr>
                    <th>Programa Educativo</th>
                    {% for cp in ciclos %}
                        <th>{{ cp.periodo.nombre }} {{ cp.ciclo.anio }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for programa in programas_antiguos %}
                <tr class="fila-antiguo">
                    <td><strong>{{ programa.nombre }}</strong></td>
                    {% for cp in ciclos %}
                        {% with key='antiguo_'|add:programa.id|stringformat:"s" %}
                        <td>
                            <input type="number" name="celda_antiguo_{{ programa.id }}_{{ cp.id }}"
                                   value="{{ datos|get_item:key|get_item:cp.id|default:'' }}"
                                   class="form-control text-center" min="0">
                        </td>
                        {% endwith %}
                    {% endfor %}
                </tr>
                {% endfor %}

                {% for programa in programas_nuevos %}
                <tr class="fila-nuevo">
                    <td><strong>{{ programa.nombre }}</strong></td>
                    {% for cp in ciclos %}
                        {% with key='nuevo_'|add:programa.id|stringformat:"s" %}
                        <td>
                            <input type="number" name="celda_nuevo_{{ programa.id }}_{{ cp.id }}"
                                   value="{{ datos|get_item:key|get_item:cp.id|default:'' }}"
                                   class="form-control text-center" min="0">
                        </td>
                        {% endwith %}
                    {% endfor %}
                </tr>
                {% endfor %}

                <tr class="fila-total">
                    <td><strong>TOTAL MATR칈CULA</strong></td>
                    {% for cp in ciclos %}
                        <td><strong>{{ totales_por_ciclo|get_item:cp.id|default:"-" }}</strong></td>
                    {% endfor %}
                </tr>
            </tbody>
        </table>
    </div>
    <div class="text-center mt-3">
        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
    </div>
</form>

<!-- Filtros -->
<hr class="my-4">
<h5 class="text-center mt-4">Visualizaci칩n Gr치fica</h5>

<div class="text-center mb-4">
    <label><strong>Selecciona las gr치ficas:</strong></label>
    <div id="filtroGraficas" class="d-flex justify-content-center flex-wrap gap-3 mt-2">
        <label><input type="checkbox" value="graficoMatriculaTotal" checked> Matr칤cula Total (Gr치fico Lineal)</label>
        <label><input type="checkbox" value="graficoMatriculaCarrera" checked> Matr칤cula por Carrera (Gr치fico de Barras)</label>
        <label><input type="checkbox" value="graficoPastelCarreras" checked> Distribuci칩n por Carrera (Gr치fico Pastel)</label>
        <label><input type="checkbox" value="graficoGauss" checked>Distribuci칩n Gaussiana</label>
    </div>

    <div class="mt-3 text-center">
        <label><strong>Selecciona los ciclos:</strong></label>
        <select id="filtro-ciclos" class="form-control" multiple>
            {% for ciclo in ciclos %}
                <option value="{{ ciclo.periodo.nombre }} {{ ciclo.ciclo.anio }}">{{ ciclo.periodo.nombre }} {{ ciclo.ciclo.anio }}</option>
            {% endfor %}
        </select>
    </div>

    <button id="btnMostrarTodas" class="btn btn-success mt-3">Mostrar Todas</button>
</div>

<div class="text-center mt-4">
    <button id="btnDescargarPDF" class="btn btn-danger">
        游늯 Descargar PDF
    </button>
</div>

<!-- Gr치ficas -->
<!-- Gr치ficas -->
<div id="contenedorGraficas" class="container mt-4">
    <div class="row justify-content-center text-center">
        <div id="graficoMatriculaTotalContainer" class="col-12 col-md-6 mb-4">
            <h6>Matr칤cula Total (Gr치fico Lineal)</h6>
            <canvas id="graficoMatriculaTotal" height="200"></canvas>
        </div>
        <div id="graficoMatriculaCarreraContainer" class="col-12 col-md-6 mb-4">
            <h6>Matr칤cula por Carrera (Gr치fico de Barras)</h6>
            <canvas id="graficoMatriculaCarrera" height="200"></canvas>
        </div>
        <div id="graficoPastelCarrerasContainer" class="col-12 col-md-6 mb-4">
            <h6>Distribuci칩n por Carrera (Gr치fico Pastel)</h6>
            <canvas id="graficoPastelCarreras" height="200"></canvas>
        </div>
        <div id="graficoGaussContainer" class="col-12 col-md-6 mb-4">
            <h6>Distribuci칩n Gaussiana</h6>
            <canvas id="graficoGauss" height="200"></canvas>
        </div>
    </div>
</div>


<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script id="labels-data" type="application/json">{{ labels_json|safe }}</script>
<script id="totales-data" type="application/json">{{ totales_json|safe }}</script>
<script id="programas-data" type="application/json">{{ programas_json|safe }}</script>
<script src="{% static 'js/matriculahistoricac.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

{% endblock %}
