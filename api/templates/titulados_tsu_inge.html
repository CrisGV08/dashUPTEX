{% extends 'base_admin.html' %} 
{% load static %}

{% block title %}Titulados por TSU e Ingenier√≠a{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/titulados_historicos.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>

<!-- Librer√≠as -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

<!-- html2pdf (estable, sin integrity que bloquea) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<style>
  .btn-admin.btn-active{ box-shadow:0 0 0 3px rgba(46,134,222,.25) inset; filter:brightness(.96); }
  .chart-box{ position:relative; width:100%; height:360px; }
  .chart-card{ min-height:0 }
  .chart-card__title{ margin-bottom:4px }
  .chart-box canvas{ display:block; width:100% !important; height:100% !important; max-height:100% !important; flex:0 0 auto !important; }
  @media (max-width:640px){ .chart-box{ height:300px } }
  @media print{ .chart-card{ break-inside:avoid; page-break-inside:avoid; } }
</style>

<div class="admin-panel">
  <h1 class="titulo">üìò Titulados por TSU e Ingenier√≠a</h1>

  {% if messages %}
    {% for message in messages %}
      <div class="mensaje-exito">{{ message|safe }}</div>
    {% endfor %}
  {% endif %}

  <!-- Toggle nivel (TSU / ING) -->
  <div class="filtros" style="justify-content:center; gap:10px">
    <form method="get" action="" style="display:flex; gap:8px; align-items:center;">
      <input type="hidden" name="nivel" value="TSU">
      <button class="btn-admin {% if nivel == 'TSU' %}btn-active{% endif %}" type="submit">TSU</button>
    </form>
    <form method="get" action="" style="display:flex; gap:8px; align-items:center;">
      <input type="hidden" name="nivel" value="ING">
      <button class="btn-admin {% if nivel == 'ING' %}btn-active{% endif %}" type="submit">Ingenier√≠a</button>
    </form>
  </div>

  <!-- Filtros -->
  <div class="filtros" id="filtrosTI" aria-label="Filtros de b√∫squeda">
    <div>
      <label for="fltAnio"><strong>A√±os (ingreso):</strong></label>
      <select id="fltAnio" multiple>
        {% for a in anios %}<option value="{{ a }}" selected>{{ a }}</option>{% endfor %}
      </select>
    </div>
    <div>
      <label for="fltPrograma"><strong>Programas:</strong></label>
      <select id="fltPrograma" multiple style="min-width:260px">
        {% for p in programas_disponibles %}<option value="{{ p }}" selected>{{ p }}</option>{% endfor %}
      </select>
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
      <button type="button" class="btn-admin" id="btnAplicar">Aplicar</button>
      <button type="button" class="btn-admin" id="btnReset">Reset</button>
    </div>
  </div>

  <!-- Exportaci√≥n -->
  <div class="filtros" style="justify-content:center; gap:10px">
    <button class="btn-admin btn-icon" id="btnDescargarPDF" type="button">üìÑ Exportar PDF</button>
  </div>

  <!-- Contenedor a exportar (√öNICO) -->
  <div class="graficas" id="seccionDescargable">
    <div class="chart-card" data-chart="bar">
      <div class="chart-card__title">üìä Titulados por a√±o (Barras)</div>
      <div class="chart-box"><canvas id="chBar" aria-label="Barras titulados por a√±o"></canvas></div>
    </div>

    <div class="chart-card" data-chart="line">
      <div class="chart-card__title">üìà Titulados por a√±o (L√≠nea)</div>
      <div class="chart-box"><canvas id="chLine" aria-label="L√≠nea titulados por a√±o"></canvas></div>
    </div>

    <div class="chart-card" data-chart="pie">
      <div class="chart-card__title">ü•ß Total Titulados vs DGP</div>
      <div class="chart-box"><canvas id="chPie" aria-label="Pastel titulados vs DGP"></canvas></div>
    </div>

    <div class="chart-card" data-chart="gauss">
      <div class="chart-card__title">üìâ Curva Gauss (sobre totales por a√±o)</div>
      <div class="chart-box"><canvas id="chGauss" aria-label="Curva de distribuci√≥n"></canvas></div>
      <small class="text-muted">Se calcula con media y desviaci√≥n de titulados por a√±o.</small>
    </div>
  </div>

  <!-- Tabla (paginada) -->
  <div class="contenedor-tabla" style="margin-top:18px">
    <h3 class="subtitulo">üìã Registros ({{ nivel }})</h3>
    <div>
      <table class="tabla-admin is-comfy">
        <thead>
          <tr>
            <th>Programa</th><th>Ingreso</th><th>Egreso</th>
            <th>Tit. H</th><th>Tit. M</th><th>DGP H</th><th>DGP M</th>
            <th>Total Tit</th><th>Total DGP</th>
          </tr>
        </thead>
        <tbody>
          {% for r in registros %}
            {% with th=r.titulados_hombres|default_if_none:0 tm=r.titulados_mujeres|default_if_none:0 dh=r.registrados_dgp_h|default_if_none:0 dm=r.registrados_dgp_m|default_if_none:0 %}
            <tr>
              <td>{% if r.programa_antiguo %}{{ r.programa_antiguo.nombre }}{% elif r.programa_nuevo %}{{ r.programa_nuevo.nombre }}{% else %}SIN PROGRAMA{% endif %}</td>
              <td>{{ r.anio_ingreso }}</td>
              <td>{{ r.anio_egreso }}</td>
              <td>{{ th }}</td><td>{{ tm }}</td><td>{{ dh }}</td><td>{{ dm }}</td>
              <td>{{ th|add:tm }}</td>
              <td>{{ dh|add:dm }}</td>
            </tr>
            {% endwith %}
          {% empty %}
            <tr><td colspan="9"><div class="empty">Sin datos.</div></td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if page_obj.has_other_pages %}
      <div class="paginacion" style="display:flex; gap:8px; justify-content:center; margin-top:12px;">
        {% if page_obj.has_previous %}<a class="btn-admin" href="?page={{ page_obj.previous_page_number }}&nivel={{ nivel }}">‚Üê Anterior</a>{% endif %}
        <span class="text-muted" style="align-self:center;">P√°gina {{ page_obj.number }} de {{ paginator.num_pages }}</span>
        {% if page_obj.has_next %}<a class="btn-admin" href="?page={{ page_obj.next_page_number }}&nivel={{ nivel }}">Siguiente ‚Üí</a>{% endif %}
      </div>
    {% endif %}
  </div>
</div>

<!-- Datos para JS -->
{{ datos_json|json_script:"datosTI" }}
<script>window.__NIVEL_TI__ = "{{ nivel }}";</script>

<!-- JS de la p√°gina -->
<script src="{% static 'js/titulados_tsu_inge.js' %}?v={{ now|date:'U' }}"></script>

<!-- Exportaci√≥n robusta -->
<script>
(() => {
  const btn  = document.getElementById('btnDescargarPDF');
  const nodo = document.getElementById('seccionDescargable');
  const CDN  = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js';

  if (!btn)  console.warn('[PDF] No encuentro #btnDescargarPDF');
  if (!nodo) console.warn('[PDF] No encuentro #seccionDescargable');

  function ensureHtml2Pdf(){
    return new Promise((resolve, reject) => {
      if (typeof window.html2pdf !== 'undefined') return resolve();
      const s = document.createElement('script');
      s.src = CDN; s.async = true;
      s.onload = resolve; s.onerror = () => reject(new Error('No se pudo cargar html2pdf'));
      document.head.appendChild(s);
    });
  }

  btn?.addEventListener('click', async () => {
    try{
      await ensureHtml2Pdf();

      // Ajusta tama√±o final de los charts antes del snapshot
      if (window.Chart) {
        nodo.querySelectorAll('canvas').forEach(cv => {
          const inst = Chart.getChart(cv);
          if (inst) inst.resize();
        });
      }

      const prevBg = nodo.style.backgroundColor;
      nodo.style.backgroundColor = '#ffffff';
      await new Promise(r => requestAnimationFrame(r));

      await html2pdf().set({
        margin: [10,10,10,10],
        filename: `titulados_{{ nivel|lower }}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, backgroundColor: '#ffffff' },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      }).from(nodo).save();

      nodo.style.backgroundColor = prevBg;
    }catch(e){
      console.error('[PDF] Error al exportar:', e);
      alert('No se pudo generar el PDF (ver consola).');
    }
  });
})();
</script>
{% endblock %}
