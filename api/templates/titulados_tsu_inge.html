{% extends "base_admin.html" %}
{% load static %}

{% block title %}Titulados â€“ CRUD (TSU / IngenierÃ­a){% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/titulados_tsu_inge.css' %}">

<style>
  .page-title{font-size:1.35rem;font-weight:700;text-align:center;margin:6px 0 14px}
  .btn.warn { background:#ef4444; color:#fff; border-color:#ef4444; }
  .btn-sm{padding:6px 10px}
  .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:50; }
  .modal { width:min(1000px, 96vw); background:#fff; border-radius:14px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.2); }
  .modal header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
  .grid { display:grid; grid-template-columns:repeat(12,1fr); gap:12px; }
  .g-3 { grid-column: span 3; } .g-6 { grid-column: span 6; } .g-12{ grid-column: span 12; }
  label { display:block; font-size:.9rem; color:#374151; margin-bottom:4px; }
  input[type="number"], select { width:100%; padding:8px 10px; border:1px solid #d1d5db; border-radius:8px; background:#fff; }
  .actions { display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }
</style>

<!-- CSRF helper -->
<script>
  function getCookie(name){const v=`; ${document.cookie}`.split(`; ${name}=`);if(v.length===2)return v.pop().split(';').shift();}
  window.CSRF_TOKEN = getCookie('csrftoken');
</script>

<h2 class="page-title">Titulados â€“ TSU / IngenierÃ­a</h2>

<div class="card" id="tsui-root"
     data-api-list="{% url 'tsui_api' %}"
     data-api-programas="{% url 'tsui_programas_api' %}"
     data-api-create="{% url 'tsui_create' %}"`
     data-api-ud-base="{% url 'tsui_update_delete' 1 %}">
  <div class="toolbar space-between">
    <div class="left">
      <button class="btn-tab active" data-nivel="TODOS" id="tabTodos">Todos</button>
      <button class="btn-tab" data-nivel="TSU" id="tabTSU">TSU</button>
      <button class="btn-tab" data-nivel="ING" id="tabING">IngenierÃ­a</button>
    </div>
    <div class="right">
      <button class="btn" id="btnPdf">Descargar PDF</button>
      <button class="btn primary" id="btnNuevo">+ Nuevo registro</button>
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div class="row">
      <div class="col">
        <label><b>Programa:</b></label>
        <div class="toolbar gap-8">
          <label class="btn-tab active" id="ptTodos">Todos</label>
          <label class="btn-tab" id="ptAntiguo">Antiguo</label>
          <label class="btn-tab" id="ptNuevo">Nuevo</label>
        </div>
      </div>
      <div class="col">
        <label><b>Carrera:</b></label>
        <select id="filtroCarrera"></select>
      </div>
      <div class="col">
        <label><b>AÃ±o ingreso:</b></label>
        <input id="anioIngreso" type="number" placeholder="AÃ±o ingreso">
      </div>
      <div class="col">
        <label><b>AÃ±o egreso:</b></label>
        <input id="anioEgreso" type="number" placeholder="AÃ±o egreso">
      </div>
    </div>
    <div class="toolbar right" style="margin-top:10px;">
      <button class="btn primary" id="btnAplicar">Aplicar</button>
      <button class="btn ghost" id="btnReset">Reset</button>
    </div>
  </div>

  <div class="card" style="margin-top:14px;">
    <div class="toolbar space-between">
      <div><b>ðŸ“„ Registros</b> <span class="chip" id="chipCount">0</span></div>
    </div>

      <div class="chart-tabs">
        <button class="btn-tab active" data-chart="bar">Barras</button>
        <button class="btn-tab" data-chart="line">LÃ­neas</button>
        <button class="btn-tab" data-chart="pie">Pastel</button>
      </div>

    <div class="table-wrap" style="margin-top:8px;">
      <table id="tabla">
        <thead>
          <tr>
            <th>Nivel</th>
            <th>Programa</th>
            <th>Ingreso</th>
            <th>Egreso</th>
            <th>Ing H</th>
            <th>Ing M</th>
            <th>Eg coh H</th>
            <th>Eg coh M</th>
            <th>Eg rez H</th>
            <th>Eg rez M</th>
            <th>Tit H</th>
            <th>Tit M</th>
            <th>DGP H</th>
            <th>DGP M</th>
            <th>Tasa (%)</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="card" style="margin-top:14px;">
    <div class="toolbar space-between">
      <div><b>ðŸ“ˆ Tasa de TitulaciÃ³n por Nivel</b></div>
    </div>
    <canvas id="chart" height="120" style="margin-top:12px;"></canvas>
  </div>
</div>

<!-- Modal Crear/Editar -->
<div class="modal-backdrop" id="modalBk">
  <div class="modal">
    <header>
      <h3 id="modalTitle">Nuevo registro</h3>
      <button class="btn ghost" id="btnCloseModal">âœ•</button>
    </header>

    <form id="formRegistro">
      <input type="hidden" id="f_id">

      <div class="grid">
        <div class="g-3">
          <label>Nivel</label>
          <select id="f_nivel">
            <option value="TSU">TSU</option>
            <option value="ING">IngenierÃ­a</option>
          </select>
        </div>
        <div class="g-3">
          <label>Tipo de programa</label>
          <select id="f_prog_tipo">
            <option value="antiguo">Antiguo</option>
            <option value="nuevo">Nuevo</option>
          </select>
        </div>
        <div class="g-6">
          <label>Programa</label>
          <select id="f_programa"></select>
        </div>

        <div class="g-3">
          <label>Mes ingreso (1-12)</label>
          <input type="number" id="f_mes_ing" min="1" max="12" value="1">
        </div>
        <div class="g-3">
          <label>AÃ±o ingreso</label>
          <input type="number" id="f_anio_ing" value="2020">
        </div>
        <div class="g-3">
          <label>Mes egreso (1-12)</label>
          <input type="number" id="f_mes_egr" min="1" max="12" value="12">
        </div>
        <div class="g-3">
          <label>AÃ±o egreso</label>
          <input type="number" id="f_anio_egr" value="2023">
        </div>

        <div class="g-3"><label>Ingreso H</label><input type="number" id="f_ing_h" value="0"></div>
        <div class="g-3"><label>Ingreso M</label><input type="number" id="f_ing_m" value="0"></div>

        <div class="g-3"><label>Eg cohorte H</label><input type="number" id="f_eg_coh_h" value="0"></div>
        <div class="g-3"><label>Eg cohorte M</label><input type="number" id="f_eg_coh_m" value="0"></div>

        <div class="g-3"><label>Eg rezag. H</label><input type="number" id="f_eg_rez_h" value="0"></div>
        <div class="g-3"><label>Eg rezag. M</label><input type="number" id="f_eg_rez_m" value="0"></div>

        <div class="g-3"><label>Titulados H</label><input type="number" id="f_tit_h" value="0"></div>
        <div class="g-3"><label>Titulados M</label><input type="number" id="f_tit_m" value="0"></div>

        <div class="g-3"><label>DGP H</label><input type="number" id="f_dgp_h" value="0"></div>
        <div class="g-3"><label>DGP M</label><input type="number" id="f_dgp_m" value="0"></div>
      </div>

      <div class="actions">
        <button type="button" class="btn" id="btnCancelModal">Cancelar</button>
        <button type="submit" class="btn primary" id="btnGuardar">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<!-- PDF libs -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>
<!-- App JS -->
<script src="{% static 'js/titulados_tsu_inge.js' %}"></script>
{% endblock %}
