{% extends 'base_admin.html' %} 
{% load static %}

{% block title %}Titulados por TSU e Ingeniería{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/titulados_historicos.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>

<!-- DataTables CSS (Bootstrap 5 + Responsive) -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css"/>
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css"/>

<!-- Librerías -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

<!-- jQuery (si ya está en base_admin, puedes quitar esta línea) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

<!-- html2pdf -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<style>
  .btn-admin.btn-active{ box-shadow:0 0 0 3px rgba(46,134,222,.25) inset; filter:brightness(.96); }
  .chart-box{ position:relative; width:100%; height:360px; }
  .chart-card{ min-height:0 }
  .chart-card__title{ margin-bottom:4px }
  .chart-box canvas{ display:block; width:100% !important; height:100% !important; max-height:100% !important; flex:0 0 auto !important; }
  @media (max-width:640px){ .chart-box{ height:300px } }
  @media print{ .chart-card{ break-inside:avoid; page-break-inside:avoid; } }

  /* Tabla moderna */
  #tablaTI{ width:100% !important; }
  #tablaTI thead th{ text-align:center; white-space:nowrap; }
  #tablaTI td.num{ text-align:right; }
  .dataTables_wrapper .dataTables_filter input{
    width:220px; padding:.35rem .6rem; border-radius:.5rem;
  }
  .dataTables_wrapper .dataTables_length select{
    padding:.25rem .4rem; border-radius:.4rem;
  }

  .actions-grid{
    display:grid; gap:10px; grid-template-columns:repeat(auto-fit, minmax(260px, 1fr));
    align-items:center; justify-content:center; width:100%;
  }
  .inline-form{
    display:flex; gap:8px; align-items:center; justify-content:center; flex-wrap:wrap;
  }
  .inline-form input[type="file"]{ max-width:220px; }
</style>

<div class="admin-panel">
  <h1 class="titulo">📘 Titulados por TSU e Ingeniería</h1>

  {% if messages %}
    {% for message in messages %}
      <div class="mensaje-exito">{{ message|safe }}</div>
    {% endfor %}
  {% endif %}

  <!-- Toggle nivel (TSU / ING) -->
  <div class="filtros" style="justify-content:center; gap:10px">
    <form method="get" action="" style="display:flex; gap:8px; align-items:center;">
      <input type="hidden" name="nivel" value="TSU">
      <button class="btn-admin {% if nivel == 'TSU' %}btn-active{% endif %}" type="submit">TSU</button>
    </form>
    <form method="get" action="" style="display:flex; gap:8px; align-items:center;">
      <input type="hidden" name="nivel" value="ING">
      <button class="btn-admin {% if nivel == 'ING' %}btn-active{% endif %}" type="submit">Ingeniería</button>
    </form>
  </div>

  <!-- Filtros -->
  <div class="filtros" id="filtrosTI" aria-label="Filtros de búsqueda">
    <div>
      <label for="fltAnio"><strong>Años (ingreso):</strong></label>
      <select id="fltAnio" multiple>
        {% for a in anios %}<option value="{{ a }}" selected>{{ a }}</option>{% endfor %}
      </select>
    </div>
    <div>
      <label for="fltPrograma"><strong>Programas:</strong></label>
      <select id="fltPrograma" multiple style="min-width:260px">
        {% for p in programas_disponibles %}<option value="{{ p }}" selected>{{ p }}</option>{% endfor %}
      </select>
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
      <button type="button" class="btn-admin" id="btnAplicar">Aplicar</button>
      <button type="button" class="btn-admin" id="btnReset">Reset</button>
    </div>
  </div>

  <!-- Acciones: Exportar / Plantillas Excel (TSU e ING separados) -->
  <div class="filtros">
    <div class="actions-grid">
      <!-- Exportar PDF -->
      <div class="inline-form">
        <button class="btn-admin btn-icon" id="btnDescargarPDF" type="button">📄 Exportar PDF</button>
      </div>

      <!-- TSU: Descargar + Subir -->
      <div class="inline-form">
        <form method="GET" action="{% url 'descargar_plantilla_titulados_tsu' %}">
          <button type="submit" class="btn-admin btn-icon">⬇️ Descargar plantilla TSU (5)</button>
        </form>
        <form method="POST" action="{% url 'subir_titulados_tsu_excel' %}" enctype="multipart/form-data" class="inline-form">
          {% csrf_token %}
          <label class="btn-admin btn-icon mb-0" style="cursor:pointer;">
            📁 Seleccionar Excel TSU
            <input type="file" name="archivo_excel_tsu" accept=".xlsx" hidden required>
          </label>
          <button type="submit" class="btn-admin btn-icon">⬆️ Subir TSU a BD</button>
        </form>
      </div>

      <!-- INGENIERÍA: Descargar + Subir -->
      <div class="inline-form">
        <form method="GET" action="{% url 'descargar_plantilla_titulados_ing' %}">
          <button type="submit" class="btn-admin btn-icon">⬇️ Descargar plantilla ING (10)</button>
        </form>
        <form method="POST" action="{% url 'subir_titulados_ing_excel' %}" enctype="multipart/form-data" class="inline-form">
          {% csrf_token %}
          <label class="btn-admin btn-icon mb-0" style="cursor:pointer;">
            📁 Seleccionar Excel ING
            <input type="file" name="archivo_excel_ing" accept=".xlsx" hidden required>
          </label>
          <button type="submit" class="btn-admin btn-icon">⬆️ Subir ING a BD</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Contenedor a exportar (ÚNICO) -->
  <div class="graficas" id="seccionDescargable">
    <div class="chart-card" data-chart="bar">
      <div class="chart-card__title">📊 Titulados por año (Barras)</div>
      <div class="chart-box"><canvas id="chBar" aria-label="Barras titulados por año"></canvas></div>
    </div>

    <div class="chart-card" data-chart="line">
      <div class="chart-card__title">📈 Titulados por año (Línea)</div>
      <div class="chart-box"><canvas id="chLine" aria-label="Línea titulados por año"></canvas></div>
    </div>

    <div class="chart-card" data-chart="pie">
      <div class="chart-card__title">🥧 Total Titulados vs DGP</div>
      <div class="chart-box"><canvas id="chPie" aria-label="Pastel titulados vs DGP"></canvas></div>
    </div>

    <div class="chart-card" data-chart="gauss">
      <div class="chart-card__title">📉 Curva Gauss (sobre totales por año)</div>
      <div class="chart-box"><canvas id="chGauss" aria-label="Curva de distribución"></canvas></div>
      <small class="text-muted">Se calcula con media y desviación de titulados por año.</small>
    </div>
  </div>

  <!-- Tabla (DataTables) -->
  <div class="contenedor-tabla" style="margin-top:18px">
    <h3 class="subtitulo">📋 Registros ({{ nivel }})</h3>
    <div class="table-responsive">
      <table id="tablaTI" class="table table-striped table-hover table-bordered table-sm align-middle nowrap">
        <thead class="table-primary">
          <tr>
            <th>Programa</th><th>Ingreso</th><th>Egreso</th>
            <th>Tit. H</th><th>Tit. M</th><th>DGP H</th><th>DGP M</th>
            <th>Total Tit</th><th>Total DGP</th>
          </tr>
        </thead>
        <tbody>
          {% for r in registros %}
            {% with th=r.titulados_hombres|default_if_none:0 tm=r.titulados_mujeres|default_if_none:0 dh=r.registrados_dgp_h|default_if_none:0 dm=r.registrados_dgp_m|default_if_none:0 %}
            <tr>
              <td>{% if r.programa_antiguo %}{{ r.programa_antiguo.nombre }}{% elif r.programa_nuevo %}{{ r.programa_nuevo.nombre }}{% else %}SIN PROGRAMA{% endif %}</td>
              <td class="num">{{ r.anio_ingreso }}</td>
              <td class="num">{{ r.anio_egreso }}</td>
              <td class="num">{{ th }}</td>
              <td class="num">{{ tm }}</td>
              <td class="num">{{ dh }}</td>
              <td class="num">{{ dm }}</td>
              <td class="num">{{ th|add:tm }}</td>
              <td class="num">{{ dh|add:dm }}</td>
            </tr>
            {% endwith %}
          {% empty %}
            <tr><td colspan="9"><div class="empty">Sin datos.</div></td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Datos para JS -->
{{ datos_json|json_script:"datosTI" }}
<script>window.__NIVEL_TI__ = "{{ nivel }}";</script>

<!-- JS de la página (gráficas/filtrado) -->
<script src="{% static 'js/titulados_tsu_inge.js' %}?v={{ now|date:'U' }}"></script>

<!-- Inicialización UI (Choices + DataTables) y PDF -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Choices multiselect
    if (window.Choices) {
      new Choices('#fltAnio', { removeItemButton:true, shouldSort:false });
      new Choices('#fltPrograma', { removeItemButton:true, shouldSort:true });
    }

    // Formateador miles
    const nf = new Intl.NumberFormat('es-MX', { maximumFractionDigits: 2 });

    // DataTables
    $('#tablaTI').DataTable({
      responsive: true,
      autoWidth: false,
      pageLength: 5,
      lengthMenu: [[5,10,25,50,-1],[5,10,25,50,'Todos']],
      order: [[1,'asc'], [0,'asc']],
      columnDefs: [
        { targets: [1,2,3,4,5,6,7,8], className:'num',
          render: function(data, type){
            if (type==='display' || type==='filter'){
              const v = parseFloat(String(data).replace(',', '.'));
              return isNaN(v) ? data : nf.format(v);
            }
            return data;
          }
        },
        { targets: '_all', className: 'dt-head-center' }
      ],
      language: {
        url: 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/es-ES.json',
        searchPlaceholder: 'Buscar en la tabla...'
      },
      dom: '<"d-flex justify-content-between align-items-center mb-2"lfr>t<"d-flex justify-content-between align-items-center mt-2"ip>'
    });

    // Exportar PDF
    const btn = document.getElementById('btnDescargarPDF');
    const nodo = document.getElementById('seccionDescargable');
    btn?.addEventListener('click', async () => {
      try{
        if (window.Chart) {
          nodo.querySelectorAll('canvas').forEach(cv => {
            const inst = Chart.getChart(cv);
            if (inst) inst.resize();
          });
        }
        const prevBg = nodo.style.backgroundColor;
        nodo.style.backgroundColor = '#ffffff';
        await new Promise(r => requestAnimationFrame(r));

        await html2pdf().set({
          margin: [10,10,10,10],
          filename: `titulados_{{ nivel|lower }}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2, useCORS: true, backgroundColor: '#ffffff' },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).from(nodo).save();

        nodo.style.backgroundColor = prevBg;
      }catch(e){
        console.error('[PDF] Error al exportar:', e);
        alert('No se pudo generar el PDF (ver consola).');
      }
    });
  });
</script>
{% endblock %}
