{% extends 'base.html' %}
{% load static %}

{% block title %}游닁 Matr칤cula Anual{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/matricula_anual.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />

<div class="admin-panel">
  <h2 class="titulo-vista">游닁 Matr칤cula Anual</h2>

  <!-- 游꿢 Filtros (GET) -->
  <form method="get" class="filtros">
    <!-- A침o (m칰ltiple) -->
    <div class="form-group">
      <label for="filtroAnio">A침o:</label>
      <select id="filtroAnio" name="filtroAnio" multiple>
        {% for anio in anios_lista %}
          <option value="{{ anio }}"
                  {% if filtro_anios_sel and anio in filtro_anios_sel %}selected{% endif %}>
            {{ anio }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Cuatrimestre -->
    <div class="form-group">
      <label for="filtroCuatrimestre">Cuatrimestre:</label>
      <select id="filtroCuatrimestre" name="cuatrimestre">
        <option value="Todos" {% if filtro_cuatrimestre_sel == "Todos" %}selected{% endif %}>Todos</option>
        <option value="Enero - Abril" {% if filtro_cuatrimestre_sel == "Enero - Abril" %}selected{% endif %}>Enero - Abril</option>
        <option value="Mayo - Agosto" {% if filtro_cuatrimestre_sel == "Mayo - Agosto" %}selected{% endif %}>Mayo - Agosto</option>
        <option value="Septiembre - Diciembre" {% if filtro_cuatrimestre_sel == "Septiembre - Diciembre" %}selected{% endif %}>Septiembre - Diciembre</option>
      </select>
    </div>

    <!-- Tipo de Programa -->
    <div class="form-group">
      <label for="filtroPrograma">Tipo de Programa:</label>
      <select id="filtroPrograma" name="tipo_programa">
        <option value="todos"  {% if tipo_programa == "todos" %}selected{% endif %}>Todos</option>
        <option value="antiguo" {% if tipo_programa == "antiguo" %}selected{% endif %}>Antiguo</option>
        <option value="nuevo"  {% if tipo_programa == "nuevo" %}selected{% endif %}>Nuevo</option>
      </select>
    </div>

    <!-- Carreras (m칰ltiple) -->
    <div class="form-group">
      <label for="filtroCarreras">Carreras:</label>
      <select id="filtroCarreras" name="filtroCarreras" multiple>
        {% for p in programas_catalogo %}
          <option value="{{ p.id }}"
                  {% if filtro_carreras_sel and p.id|stringformat:"s" in filtro_carreras_sel %}selected{% endif %}>
            {{ p.nombre }}
          </option>
        {% endfor %}
      </select>
    </div>

    <button type="submit" class="btn-admin">Aplicar filtros</button>
  </form>

  <!-- 游늵 Tabla por a침o -->
  <div class="tabla-container">
    <h4>游늵 Detalle por A침o</h4>
    <table class="tabla-matricula">
      <thead>
        <tr>
          <th>A침o</th>
          <th>Programa</th>
          <th>Ene-Abr</th>
          <th>May-Ago</th>
          <th>Sep-Dic</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        {% if tabla_datos and tabla_datos|length > 0 %}
          {% for fila in tabla_datos %}
          <tr>
            <td>{{ fila.anio }}</td>
            <td>{{ fila.programa }}</td>
            <td>{{ fila.ene_abr }}</td>
            <td>{{ fila.may_ago }}</td>
            <td>{{ fila.sep_dic }}</td>
            <td>{{ fila.total }}</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="6" class="text-center text-muted">Sin resultados con los filtros seleccionados.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- 游늳 Gr치ficas -->
  <div id="contenedorGraficas"
       data-antiguos='{{ data_antiguos_json|safe }}'
       data-nuevos='{{ data_nuevos_json|safe }}'
       data-carreras-antiguos='{{ programas_antiguos_lista|safe }}'
       data-carreras-nuevos='{{ programas_nuevos_lista|safe }}'>

    <canvas id="graficaBarras"></canvas>
    <canvas id="graficaLinea"></canvas>
    <canvas id="graficaPastel"></canvas>
    <canvas id="graficaGauss"></canvas>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="{% static 'js/matricula_anual.js' %}"></script>
<script>
  // Inicializa Choices para selects m칰ltiples
  document.addEventListener('DOMContentLoaded', function () {
    try {
      new Choices('#filtroAnio', { removeItemButton: true, shouldSort: false });
      new Choices('#filtroCarreras', { removeItemButton: true, shouldSort: true });
    } catch (e) { /* opcional */ }
  });
</script>
{% endblock %}
