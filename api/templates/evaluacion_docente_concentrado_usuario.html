{% extends 'base.html' %}
{% load static %}

{% block title %}Evaluaci칩n Docente Concentrado{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/evaluacion_docente_concentrado.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">

<div class="admin-panel">
  <h2 class="titulo-principal">游닂 Evaluaci칩n Docente Concentrado</h2>

  <!-- Filtro por A침o construido en el front (igual que examen admisi칩n) -->
  <form method="get" id="formAnio"
        data-anios='{{ anios_validos_json|safe }}'
        data-actual='{{ anio_sel }}'
        class="mb-3 d-flex align-items-center gap-2 ocultar-en-pdf">
    <label class="form-label mb-0" for="anioSel">A침o:</label>
    <select id="anioSel" name="anio" class="form-select" style="max-width: 160px;"></select>
    <button class="btn btn-primary">Aplicar</button>
  </form>

  <!-- Filtros de gr치ficas -->
  <div class="filtros ocultar-en-pdf">
    <h5>Filtros</h5>
    <div class="form-group">
      <label for="select-ciclos">Seleccionar ciclos:</label>
      <select id="select-ciclos" multiple></select>
    </div>
    <div class="form-group">
      <label>Seleccionar gr치ficas:</label><br>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="linea" checked>
        <label class="form-check-label" for="linea">游늳 L칤nea</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="barras" checked>
        <label class="form-check-label" for="barras">游늵 Barras</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="pastel" checked>
        <label class="form-check-label" for="pastel">游볺 Pastel</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="gauss" checked>
        <label class="form-check-label" for="gauss">游늴 Campana de Gauss</label>
      </div>
    </div>
  </div>

  <!-- Tabla -->
  <div class="tabla-contenedor">
    <table class="table">
      <thead>
        <tr>
          <th>A침o</th>
          <th>Promedio</th>
        </tr>
      </thead>
      <tbody>
        {% for item in datos %}
          <tr>
            <td>{{ item.anio }}</td>
            <td>{{ item.promedio }}</td>
          </tr>
        {% endfor %}
        <tr>
          <th style="text-align:right;">Promedio General Total:</th>
          <td style="font-weight:bold; text-align:center;">{{ promedio_general_total|floatformat:2 }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Gr치ficas -->
  <div class="fila-graficas">
    <!-- Gr치ficas de Promedio Total -->
    <div class="columna-total">
      <div class="grafica-total-box" id="box-linea-total">
        <canvas id="grafica-linea-total"></canvas>
      </div>
      <div class="grafica-total-box" id="box-barras-total">
        <canvas id="grafica-barras-total"></canvas>
      </div>
      <div class="grafica-total-box" id="box-pastel-total">
        <canvas id="grafica-pastel-total"></canvas>
      </div>
      <div class="grafica-total-box" id="box-gauss-total">
        <canvas id="grafica-gauss-total"></canvas>
      </div>
    </div>

    <!-- Gr치ficas por Ciclo -->
    <div class="columna-ciclo">
      <div class="grafica-box" id="box-linea">
        <canvas id="grafica-linea"></canvas>
      </div>
      <div class="grafica-box" id="box-barras">
        <canvas id="grafica-barras"></canvas>
      </div>
      <div class="grafica-box" id="box-pastel">
        <canvas id="grafica-pastel"></canvas>
      </div>
      <div class="grafica-box" id="box-gauss">
        <canvas id="grafica-gauss"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<!-- Datos para JS principal (solo el a침o filtrado) -->
<script>
  const datosEvaluacion = [
    {% for d in datos %}
      { ciclo: "{{ d.anio }}", promedio: {{ d.promedio }} },
    {% endfor %}
  ];
</script>

<!-- Construcci칩n din치mica del select de A침os -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('formAnio');
    const sel  = document.getElementById('anioSel');
    if (!form || !sel) return;

    let anios = [];
    try { anios = JSON.parse(form.dataset.anios || '[]'); } catch (_) { anios = []; }

    if (!Array.isArray(anios) || anios.length === 0) {
      const de = Array.isArray(window.datosEvaluacion) ? window.datosEvaluacion : [];
      const candidatos = de.map(d => String(d.ciclo)).filter(Boolean);
      anios = [...new Set(candidatos)].sort((a,b)=>(+a)-(+b));
    }

    if (anios.length === 0) { anios = [String(form.dataset.actual || '2025')]; }

    const actual = String(form.dataset.actual || '');
    sel.innerHTML = '';
    anios.forEach(a => {
      const opt = document.createElement('option');
      opt.value = a;
      opt.textContent = a;
      if (a === actual) opt.selected = true;
      sel.appendChild(opt);
    });

    sel.addEventListener('change', () => form.submit());
  });
</script>

<script src="{% static 'js/evaluacion_docente_concentrado_usuario.js' %}"></script>
{% endblock %}
